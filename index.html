<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TINJU ‚ö° Monitoring PJU Barito Timur</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  font-family: "Segoe UI", sans-serif;
  margin: 0;
  background: radial-gradient(circle at center, #000015, #000);
  color: #0ff;
  overflow-x: hidden;
}

/* Header */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(90deg, #0033ff, #00e6ff);
  color: white;
  padding: 10px 20px;
  box-shadow: 0 0 20px #00ffff;
}
header h2 { margin: 0; }
#userInfo { font-weight: bold; }

/* Form container */
form {
  background: rgba(0,0,20,0.9);
  margin: 20px auto;
  max-width: 480px;
  padding: 20px;
  border-radius: 15px;
  border: 2px solid #00ffff55;
  box-shadow: 0 0 30px #00ffff33;
  position: relative;
}
form::before {
  content: "";
  position: absolute;
  top: -2px; left: -2px;
  width: 100%; height: 100%;
  border-radius: 15px;
  border: 2px solid #00ffff;
  filter: blur(10px);
  opacity: 0.4;
  animation: lightning 3s infinite linear;
}
@keyframes lightning {
  0%,100% { opacity:0.4; box-shadow: 0 0 10px #00ffff; }
  50% { opacity:1; box-shadow: 0 0 30px #00ffff; }
}

label {
  display:block;
  margin-top:10px;
  font-weight:bold;
}
input, select, textarea {
  width:100%;
  padding:8px;
  border:1px solid #00ffff55;
  border-radius:8px;
  background:#001122;
  color:#0ff;
  font-size:14px;
}
input::placeholder { color:#00cccc88; }

button {
  width:100%;
  background:linear-gradient(90deg,#0066ff,#00ffff);
  border:none;
  padding:10px;
  color:black;
  font-weight:bold;
  border-radius:8px;
  margin-top:10px;
  cursor:pointer;
  box-shadow:0 0 10px #00ffff;
  transition:0.3s;
}
button:hover {
  box-shadow:0 0 25px #00ffff;
  background:linear-gradient(90deg,#00ffff,#0066ff);
}

#logoutBtn {
  background: linear-gradient(90deg, #ff0066, #ff6600);
  box-shadow: 0 0 10px #ff3366;
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
}
#logoutBtn:hover { box-shadow: 0 0 20px #ff6600; }

#map, #mapData {
  height:320px;
  border-radius:10px;
  border:1px solid #00ffff44;
  margin-top:10px;
}
#stats {
  margin:20px auto;
  background:rgba(0,10,20,0.9);
  border-radius:15px;
  padding:15px;
  max-width:900px;
  box-shadow:0 0 25px #00ffff44;
}
#msg { text-align:center; margin-top:10px; font-weight:bold; color:#0ff; }
</style>
</head>

<body>
<header>
  <h2>‚ö° Monitoring PJU (TINJU) ‚ö°</h2>
  <div id="userInfo">
    üë§ <span id="namaUser">Memuat...</span>
    <button id="logoutBtn">Logout</button>
  </div>
</header>

<form id="tinjuForm" enctype="multipart/form-data">
  <label>Tanggal:</label>
  <input type="date" id="tanggal" required>

  <label>Petugas:</label>
  <input type="text" id="petugas" readonly required>

  <label>Nama Lokasi / Panel:</label>
  <input type="text" id="lokasi" required placeholder="Contoh: Panel PJU Pasar Tamiang Layang">

  <label>Koordinat:</label>
  <input type="text" id="koordinat" placeholder="üìç Tekan Ambil Lokasi Saya" readonly required>
  <div id="map"></div>
  <button type="button" id="lokasiSaya">üìç Ambil Lokasi Saya</button>

  <label>Jenis Kerusakan:</label>
  <select id="jenis" required>
    <option value="">Pilih Jenis Kerusakan</option>
    <option value="Lampu">Lampu</option>
    <option value="Jaringan Kabel">Jaringan Kabel</option>
    <option value="Kontroller/Proteksi">Kontroller/Proteksi</option>
    <option value="Short Circuit">Short Circuit</option>
    <option value="Hilang Tegangan">Hilang Tegangan</option>
    <option value="Tidak Diketahui">Tidak Diketahui</option>
  </select>

  <label>Keterangan:</label>
  <textarea id="keterangan" rows="3"></textarea>

  <label>üì∏ Upload Foto Lokasi:</label>
  <input type="file" id="foto" name="foto" accept="image/*" capture="environment">

  <button type="submit">‚úÖ Kirim Data</button>
</form>

<div id="msg"></div>
<div id="stats"><canvas id="chartJenis"></canvas></div>
<div id="mapData"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // --- Validasi login ---
const namaUser = localStorage.getItem("petugas");
const roleUser = localStorage.getItem("role");

if (!namaUser || !roleUser) {
  alert("‚ö†Ô∏è Anda harus login terlebih dahulu!");
  window.location.href = "login.html";
}

// --- Tampilkan nama login ---
document.getElementById("namaUser").textContent = namaUser;

// --- Tombol logout elektrik ---
const logoutBtn = document.getElementById("logoutBtn");
logoutBtn.addEventListener("click", () => {
  localStorage.clear();
  alert("Anda telah logout. ‚ö°");
  window.location.href = "login.html";
});

const proxy = "https://broad-queen-be12.perluasanlistrik-bartim.workers.dev/?url=";
const scriptURL = "https://script.google.com/macros/s/AKfycbwcMi_pBDlXeEzS5wxpIuiRmDjvkiwjgR53TmcfhGyi0DcKTSj3sgGXxfmPEpbVhUgg4g/exec";
const namaUser = localStorage.getItem("petugas") || "";
const roleUser = localStorage.getItem("role") || "";

// --- Cek login ---
if (!namaUser) window.location.href = "login.html";
document.getElementById("namaUser").textContent = namaUser;

// --- Logout ---
document.getElementById("logoutBtn").onclick = () => {
  localStorage.clear();
  window.location.href = "login.html";
};

// --- Tanggal otomatis hari ini ---
document.getElementById("tanggal").value = new Date().toISOString().slice(0, 10);
document.getElementById("petugas").value = namaUser;

window.onload = () => {
  // Map input
  const map = L.map('map').setView([-2.13, 115.10], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
  let marker;

  map.on('click', e => {
    const lat = e.latlng.lat.toFixed(6);
    const lng = e.latlng.lng.toFixed(6);
    document.getElementById('koordinat').value = `${lat}, ${lng}`;
    if (marker) map.removeLayer(marker);
    marker = L.marker(e.latlng).addTo(map).bindPopup(`üìç ${lat}, ${lng}`).openPopup();
  });

  document.getElementById('lokasiSaya').addEventListener('click', () => {
    if (!navigator.geolocation) return alert("GPS tidak didukung.");
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude.toFixed(6);
      const lng = pos.coords.longitude.toFixed(6);
      document.getElementById('koordinat').value = `${lat}, ${lng}`;
      map.setView([lat, lng], 17);
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map)
        .bindPopup(`üìç Lokasi Anda<br>${lat}, ${lng}`).openPopup();
    }, () => alert("Gagal mengambil lokasi."));
  });

  // --- Submit form ---
  document.getElementById('tinjuForm').addEventListener('submit', async e => {
    e.preventDefault();
    const koordinat = document.getElementById('koordinat').value.trim();
    if (!koordinat) return alert("‚ö†Ô∏è Harap ambil koordinat terlebih dahulu!");

    const file = document.getElementById('foto').files[0];
    let fotoBase64 = "";
    if (file) {
      fotoBase64 = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    const data = {
      action: "upload",
      tanggal: document.getElementById('tanggal').value,
      petugas: namaUser,
      lokasi: document.getElementById('lokasi').value,
      koordinat: koordinat,
      jenis: document.getElementById('jenis').value,
      keterangan: document.getElementById('keterangan').value,
      fotoBase64: fotoBase64
    };

    document.getElementById('msg').innerHTML = "‚è≥ Mengirim data...";
    const res = await fetch(proxy + scriptURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    const r = await res.json();
    if (r.status === "success") {
      document.getElementById('msg').innerHTML = "‚úÖ Data berhasil dikirim!";
      e.target.reset();
      loadData();
    } else {
      document.getElementById('msg').innerHTML = "‚ö†Ô∏è Gagal: " + r.message;
    }
  });

  // --- Map output ---
  const mapData = L.map('mapData').setView([-2.13, 115.10], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(mapData);

  async function loadData() {
    const res = await fetch(proxy + scriptURL);
    const data = await res.json();
    mapData.eachLayer(l => { if (l instanceof L.Marker) mapData.removeLayer(l); });

    const counts = {};
    data.forEach(d => {
      if (!d.koordinat || !d.koordinat.includes(",")) return;
      if (roleUser === "petugas" && d.petugas !== namaUser) return;

      const [lat, lng] = d.koordinat.split(",").map(v => parseFloat(v.trim()));
      counts[d.jenis] = (counts[d.jenis] || 0) + 1;

      const iconUrl = d.jenis === "Lampu" ? "https://cdn-icons-png.flaticon.com/512/702/702814.png"
                    : d.jenis === "Jaringan Kabel" ? "https://cdn-icons-png.flaticon.com/512/2504/2504959.png"
                    : d.jenis === "Kontroller/Proteksi" ? "https://cdn-icons-png.flaticon.com/512/3039/3039386.png"
                    : d.jenis === "Short Circuit" ? "https://cdn-icons-png.flaticon.com/512/1532/1532802.png"
                    : "https://cdn-icons-png.flaticon.com/512/929/929430.png";

      const customIcon = L.icon({
        iconUrl: iconUrl,
        iconSize: [28, 28],
        iconAnchor: [14, 28],
        popupAnchor: [0, -25]
      });

      const marker = L.marker([lat, lng], { icon: customIcon }).addTo(mapData);
      const popup = `
        <b>${d.lokasi}</b><br>
        üßç ${d.petugas}<br>
        üìÖ ${d.tanggal}<br>
        ‚öôÔ∏è ${d.jenis}<br>
        üìù ${d.keterangan}<br>
        ${d.foto ? `<a href="${d.foto}" target="_blank">üì∏ Lihat Foto</a>` : ''}
      `;
      marker.bindPopup(popup);
    });

    // Statistik Chart
    const ctx = document.getElementById("chartJenis").getContext("2d");
    new Chart(ctx, {
      type: "bar",
      data: {
        labels: Object.keys(counts),
        datasets: [{
          label: "Jumlah Kerusakan",
          data: Object.values(counts),
          backgroundColor: "rgba(0,255,255,0.6)",
          borderColor: "#00ffff",
          borderWidth: 1
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  loadData();
};
</script>
</body>
</html>

