<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‚ö° Dashboard TINJU PJU</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  :root{
    --neo:#00ffff; --ink:#000a12; --ink2:#001825; --glow:#00ffff66; --accent:#0aa2ff;
  }
  *{box-sizing:border-box}
  body{margin:0; background:#000; color:#cfffff; font-family:"Segoe UI",system-ui,Arial,sans-serif;}
  header{
    display:flex; justify-content:space-between; align-items:center; gap:14px;
    padding:12px 16px; background:linear-gradient(90deg,#001026,#002a4a); color:#dff;
    border-bottom:1px solid #00ffff33; box-shadow:0 0 18px #00ffff33;
    position:sticky; top:0; z-index:5;
  }
  .brand{font-weight:800; letter-spacing:.3px; text-shadow:0 0 12px #00ffffaa}
  h2{margin:16px 8px 8px; text-align:center; color:var(--neo); text-shadow:0 0 14px #00ffffaa}

  /* panel input */
  .card{
    width:min(96vw,520px); margin:14px auto; padding:14px; border-radius:16px;
    background:linear-gradient(180deg,var(--ink),var(--ink2));
    border:2px solid var(--glow); box-shadow:0 0 20px #00ffff33, inset 0 0 10px #001b28;
    position:relative; overflow:hidden;
  }
  .card::before{
    content:""; position:absolute; inset:-3px; border-radius:16px;
    background: conic-gradient(from 0deg, #00ffff90, transparent 25%, #00ffff90 55%, transparent 75%);
    filter: blur(12px); animation: arc 3.4s linear infinite;
  }
  @keyframes arc{to{transform:rotate(360deg)}}
  label{display:block; margin-top:8px; font-weight:700; color:#a9faff}
  input, select, textarea{
    width:100%; padding:10px; border-radius:10px; border:1px solid #0b3e5c;
    background:#021b2b; color:#dff; outline:0; position:relative; z-index:2;
  }
  input[readonly]{opacity:.9}
  .btn{width:100%; margin-top:10px; padding:11px; border:0; border-radius:12px; cursor:pointer;
    color:#001018; font-weight:800; background:linear-gradient(90deg,#09ffd0,#00c8ff 60%, #0077ff);
    box-shadow:0 0 16px #00ffff55; position:relative; z-index:2;
  }
  #map,#mapOut{height:320px; border-radius:12px; margin-top:8px; position:relative; z-index:2;}
  #msg{margin:8px auto; text-align:center; font-weight:800; color:#ffd57a}
  .stats{display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin:8px 8px 0}
  .chip{padding:6px 10px; border-radius:999px; border:1px solid #00ffff44; background:#001826; color:#aff; font-weight:700}
  footer{margin:20px 0 18px; text-align:center; color:#84f1ff88; font-size:12px}
</style>
</head>
<body>
<header>
  <div class="brand">‚ö° TINJU PJU</div>
  <div>üë∑ Petugas Umum</div>
</header>

<h2>üìã Form Pemeliharaan</h2>
<section class="card">
  <label>Tanggal</label>
  <input type="date" id="tgl" required />
  <label>Petugas</label>
  <input type="text" id="pet" placeholder="Nama petugas" required />
  <label>Nama Lokasi / Panel</label>
  <input type="text" id="lok" placeholder="Contoh: Panel PJU Pasar Tamiang Layang" required />
  <label>Koordinat</label>
  <input type="text" id="koo" placeholder="üìç Klik peta atau Ambil Lokasi Saya" readonly required />
  <div id="map"></div>
  <button id="geo" type="button" class="btn">üìç Ambil Lokasi Saya</button>
  <label>Jenis Kerusakan</label>
  <select id="jen" required>
    <option value="">Pilih Jenis</option>
    <option>Lampu</option><option>Jaringan Kabel</option><option>Kontroller/Proteksi</option>
    <option>Short Circuit</option><option>Hilang Tegangan</option><option>Tidak Diketahui</option>
  </select>
  <label>Keterangan</label>
  <textarea id="ket" rows="3" placeholder="Catatan singkat"></textarea>
  <label>üì∏ Foto (opsional)</label>
  <input type="file" id="fot" accept="image/*" />
  <button id="send" class="btn">‚úÖ Kirim Data</button>
  <div id="msg"></div>
</section>

<h2>üó∫Ô∏è Data Masuk</h2>
<div class="stats" id="stats"></div>
<section class="card" style="width:min(96vw,1100px);">
  <div id="mapOut"></div>
</section>

<footer>‚ö° Sistem TINJU PJU ‚Ä¢ Kabupaten Barito Timur</footer>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const PROXY = "https://broad-queen-be12.perluasanlistrik-bartim.workers.dev/?url=";
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwcMi_pBDlXeEzS5wxpIuiRmDjvkiwjgR53TmcfhGyi0DcKTSj3sgGXxfmPEpbVhUgg4g/exec";

  // default tanggal hari ini
  document.getElementById("tgl").valueAsDate = new Date();

  // === MAP INPUT ===
  const mapIn = L.map("map").setView([-2.13,115.10], 9);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(mapIn);
  let pin;
  function setKoor(lat,lng){
    document.getElementById("koo").value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    if(pin) mapIn.removeLayer(pin);
    pin = L.marker([lat,lng]).addTo(mapIn).bindPopup("üìç Lokasi").openPopup();
  }
  mapIn.on("click",e=>setKoor(e.latlng.lat,e.latlng.lng));
  document.getElementById("geo").onclick = ()=>{
    if(!navigator.geolocation) return alert("GPS tidak didukung.");
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude:lat, longitude:lng} = pos.coords;
      mapIn.setView([lat,lng], 17); setKoor(lat,lng);
    }, ()=>alert("Gagal mengambil lokasi."));
  };

  // === SUBMIT ===
  document.getElementById("send").onclick = async ()=>{
    const msg = document.getElementById("msg");
    const koo = document.getElementById("koo").value.trim();
    if(!koo){ msg.textContent="‚ö†Ô∏è Ambil koordinat dulu."; return; }

    const file = document.getElementById("fot").files[0];
    let fotoBase64 = "";
    if(file){
      fotoBase64 = await new Promise((ok,fail)=>{
        const r = new FileReader(); r.onload=()=>ok(r.result); r.onerror=fail; r.readAsDataURL(file);
      });
    }

    const data = {
      action:"upload",
      tanggal: document.getElementById("tgl").value,
      petugas: document.getElementById("pet").value,
      lokasi : document.getElementById("lok").value,
      koordinat: koo,
      jenis: document.getElementById("jen").value,
      keterangan: document.getElementById("ket").value,
      fotoBase64
    };

    msg.textContent = "‚è≥ Mengirim...";
    try{
      const res = await fetch(PROXY + SCRIPT_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(data)
      });
      const r = await res.json();
      if(r.status==="success"){
        msg.style.color="#7dff9b";
        msg.textContent="‚úÖ Data berhasil disimpan!";
        document.getElementById("lok").value="";
        document.getElementById("jen").value="";
        document.getElementById("ket").value="";
        document.getElementById("fot").value="";
        document.getElementById("koo").value="";
        if(pin) mapIn.removeLayer(pin);
        loadData();
      }else{
        msg.style.color="#ffd57a"; msg.textContent="‚ö†Ô∏è " + (r.message||"Gagal menyimpan");
      }
    }catch(e){
      msg.style.color="#ffd57a"; msg.textContent="‚ùå Koneksi gagal.";
    }
  };

  // === MAP OUTPUT + STATISTIK ===
  const mapOut = L.map("mapOut").setView([-2.13,115.10], 9);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(mapOut);
  function iconFor(jenis){
    const colors = {
      "Lampu":"#00ffd0","Jaringan Kabel":"#00c8ff","Kontroller/Proteksi":"#7bff00",
      "Short Circuit":"#ff4e78","Hilang Tegangan":"#ffaa00","Tidak Diketahui":"#b08cff"
    };
    const c = colors[jenis] || "#00e1ff";
    return L.divIcon({
      className:"", iconSize:[26,26], html:
      `<div style="width:26px;height:26px;border-radius:50%;
         box-shadow:0 0 12px ${c};
         background: radial-gradient(circle at 35% 35%, #fff, ${c} 45%, #003544 75%);
         border:2px solid #001c28"></div>`
    });
  }

  async function loadData(){
    try{
      const res = await fetch(PROXY + SCRIPT_URL);
      const data = await res.json();

      mapOut.eachLayer(l => { if(l instanceof L.Marker) mapOut.removeLayer(l); });
      const statsEl = document.getElementById("stats");
      const counter = {};

      data.forEach(d=>{
        if(!d.koordinat) return;
        const [lat,lng] = d.koordinat.split(",").map(v=>parseFloat(v));
        const popup = `
          <b>${d.lokasi||"-"}</b><br>
          üßç ${d.petugas||"-"}<br>
          üìÖ ${d.tanggal||"-"}<br>
          ‚öôÔ∏è ${d.jenis||"-"}<br>
          üìù ${d.keterangan||"-"}<br>
          ${d.foto ? `<a href="${d.foto}" target="_blank">üì∏ Lihat Foto</a>` : ""}`;
        L.marker([lat,lng], {icon:iconFor(d.jenis)}).addTo(mapOut).bindPopup(popup);
        const k = d.jenis||"Lainnya"; counter[k] = (counter[k]||0)+1;
      });

      statsEl.innerHTML = "";
      Object.keys(counter).sort().forEach(k=>{
        const s = document.createElement("div");
        s.className="chip"; s.textContent = `${k}: ${counter[k]}`;
        statsEl.appendChild(s);
      });
    }catch(e){ console.warn("Gagal load data:", e); }
  }
  loadData();
</script>
</body>
</html>
