<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚ö° TINJU PJU ‚Äì Barito Timur</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
/* ======== DASAR ======== */
body {
  font-family: 'Segoe UI', sans-serif;
  margin: 0;
  background: radial-gradient(circle at center, #000020, #000);
  color: #0ff;
  overflow-x: hidden;
  position: relative;
}

/* ======== HEADER ======== */
header {
  text-align: center;
  padding: 16px 10px;
  background: linear-gradient(90deg,#001122,#003344);
  color: #0ff;
  font-weight: bold;
  font-size: 1.1rem;
  text-shadow: 0 0 8px #00ffffaa;
  box-shadow: 0 0 25px #00ffff55;
  position: relative;
  z-index: 3;
}

/* ======== FORM ======== */
h2 {
  text-align: center;
  text-shadow: 0 0 12px #00ffff;
  margin: 18px 0 10px;
  font-size: 1.1rem;
}

form {
  background: rgba(0,15,25,.9);
  border: 1px solid #00ffff55;
  border-radius: 14px;
  box-shadow: 0 0 20px #00ffff44;
  padding: 20px;
  margin: 0 auto 20px;
  max-width: 480px;
  width: 90%;
  position: relative;
  z-index: 2;
}

label {
  display: block;
  margin-top: 10px;
  font-weight: bold;
}

input, select, textarea {
  width: 100%;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #00ffff44;
  background: #000814;
  color: #0ff;
  font-size: 14px;
}

button {
  width: 100%;
  background: linear-gradient(90deg, #00ffff, #0077ff);
  color: #000;
  font-weight: bold;
  border: none;
  border-radius: 6px;
  padding: 10px;
  margin-top: 10px;
  cursor: pointer;
  box-shadow: 0 0 15px #00ffff66;
  transition: 0.2s ease;
}

button:hover {
  box-shadow: 0 0 25px #00ffff;
}

#msg {
  text-align: center;
  margin-top: 10px;
  font-weight: bold;
  color: #0ff;
}

/* ======== PETA ======== */
#map, #mapData {
  height: 320px;
  margin-top: 10px;
  border-radius: 10px;
  z-index: 2;
}

/* ======== KANVAS EFEK KILAT ======== */
canvas#electricFX {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  pointer-events: none;
  z-index: 1;
  opacity: .5;
}

/* ======== RESPONSIVE ======== */
@media (max-width: 600px) {
  form { padding: 15px; }
  h2 { font-size: 1rem; }
  input, select, textarea { font-size: 13px; }
}
</style>
</head>

<body>
<canvas id="electricFX"></canvas>

<header>‚ö° <b>TINJU PJU Barito Timur</b></header>

<h2>üìã Form Monitoring PJU</h2>

<form id="tinjuForm">
  <label>Tanggal:</label>
  <input type="date" id="tanggal" required>

  <label>Petugas:</label>
  <select id="petugas" required>
    <optgroup label="Petugas Dinas">
      <option value="Septeriady Ngubel">Septeriady Ngubel</option>
      <option value="Kwartino Handriano">Kwartino Handriano</option>
      <option value="Pawaino">Pawaino</option>
      <option value="M. Rizki">M. Rizki</option>
      <option value="Andri Karawaheno">Andri Karawaheno</option>
      <option value="Denni Widyatsan">Denni Widyatsan</option>
    </optgroup>
    <optgroup label="Petugas Teknisi">
      <option value="Ferry Andinata">Ferry Andinata</option>
      <option value="Randelson Randin">Randelson Randin</option>
      <option value="Muharman">Muharman</option>
    </optgroup>
  </select>

  <label>Lokasi Panel:</label>
  <input type="text" id="lokasi" required placeholder="Contoh: Panel PJU Nansarunai">

  <label>Koordinat:</label>
  <input type="text" id="koordinat" readonly required placeholder="üìç Klik peta atau 'Ambil Lokasi Saya'">
  <div id="map"></div>
  <button type="button" id="lokasiSaya">üìç Ambil Lokasi Saya</button>

  <label>Jenis Kerusakan:</label>
  <select id="jenis" required>
    <option value="">Pilih Jenis</option>
    <option value="Lampu">Lampu</option>
    <option value="Jaringan Kabel">Jaringan Kabel</option>
    <option value="Kontroller/Proteksi">Kontroller/Proteksi</option>
    <option value="Short Circuit">Short Circuit</option>
    <option value="Hilang Tegangan">Hilang Tegangan</option>
    <option value="Tidak Diketahui">Tidak Diketahui</option>
  </select>

  <label>Keterangan:</label>
  <textarea id="keterangan" rows="3" placeholder="Tuliskan kondisi / catatan tambahan..."></textarea>

  <label>üì∏ Upload Foto Lokasi (bisa lebih dari satu):</label>
  <input type="file" id="foto" accept="image/*" multiple>

  <button type="submit">‚úÖ Kirim Data</button>
</form>

<div id="msg"></div>

<h2>üó∫Ô∏è Peta Data PJU</h2>
<div id="mapData"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const PROXY = "https://broad-queen-be12.perluasanlistrik-bartim.workers.dev/?url=";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwcMi_pBDlXeEzS5wxpIuiRmDjvkiwjgR53TmcfhGyi0DcKTSj3sgGXxfmPEpbVhUgg4g/exec";

// --- MAP INPUT ---
const map = L.map('map').setView([-2.13,115.10], 9);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let marker;
map.on('click', e=>{
  const lat = e.latlng.lat.toFixed(6);
  const lng = e.latlng.lng.toFixed(6);
  document.getElementById('koordinat').value = `${lat},${lng}`;
  if (marker) map.removeLayer(marker);
  marker = L.marker(e.latlng).addTo(map).bindPopup(`üìç ${lat},${lng}`).openPopup();
});
document.getElementById("lokasiSaya").addEventListener("click", ()=>{
  if (!navigator.geolocation) return alert("GPS tidak didukung browser ini.");
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude.toFixed(6);
    const lng = pos.coords.longitude.toFixed(6);
    document.getElementById('koordinat').value = `${lat},${lng}`;
    map.setView([lat,lng],17);
    if (marker) map.removeLayer(marker);
    marker = L.marker([lat,lng]).addTo(map).bindPopup("üìç Lokasi Anda").openPopup();
  }, ()=>alert("Gagal mengambil lokasi."));
});

// --- SUBMIT DATA ---
document.getElementById("tinjuForm").addEventListener("submit", async e=>{
  e.preventDefault();

  const files = Array.from(document.getElementById("foto").files);
  const fotoBase64List = await Promise.all(files.map(file => new Promise((res,rej)=>{
    const r = new FileReader();
    r.onload=()=>res(r.result);
    r.onerror=rej;
    r.readAsDataURL(file);
  })));

  const data = {
    action:"upload",
    tanggal: document.getElementById("tanggal").value,
    petugas: document.getElementById("petugas").value,
    lokasi: document.getElementById("lokasi").value,
    koordinat: document.getElementById("koordinat").value,
    jenis: document.getElementById("jenis").value,
    keterangan: document.getElementById("keterangan").value,
    fotoBase64List
  };

  document.getElementById("msg").textContent="‚ö° Mengirim data...";
  const res = await fetch(PROXY+SCRIPT_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});
  const r = await res.json();
  if (r.status==="success"){document.getElementById("msg").textContent="‚úÖ Data berhasil dikirim!"; loadData();}
  else document.getElementById("msg").textContent="‚ö†Ô∏è "+r.message;
});

// --- MAP OUTPUT ---
const mapData = L.map("mapData").setView([-2.13,115.10],9);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(mapData);

async function loadData(){
  try{
    const res = await fetch(PROXY+SCRIPT_URL);
    const data = await res.json();
    mapData.eachLayer(l=>{if(l instanceof L.Marker) mapData.removeLayer(l);});
    data.forEach(d=>{
      if(!d.koordinat) return;
      const [lat,lng]=d.koordinat.split(",").map(Number);
      let fotoHTML = "";
      if (d.foto && Array.isArray(d.foto)) {
        fotoHTML = d.foto.map((f,i)=>`<a href="${f}" target="_blank">üì∏ Foto ${i+1}</a>`).join("<br>");
      } else if (d.foto) {
        fotoHTML = `<a href="${d.foto}" target="_blank">üì∏ Lihat Foto</a>`;
      }
      const popup=`<b>${d.lokasi}</b><br>üßç ${d.petugas}<br>üìÖ ${d.tanggal}<br>‚öôÔ∏è ${d.jenis}<br>üìù ${d.keterangan}<br>${fotoHTML}`;
      const icon = L.divIcon({html:`<span style='color:#0ff;font-size:20px;text-shadow:0 0 10px #00ffff;'>‚ö°</span>`,className:""});
      L.marker([lat,lng],{icon}).addTo(mapData).bindPopup(popup);
    });
  }catch(err){console.error("Gagal load data:",err);}
}
loadData();

// === Efek Kilat Menyeluruh (ringan) ===
const c = document.getElementById("electricFX");
const ctx = c.getContext("2d");
function resize(){ c.width = innerWidth; c.height = innerHeight; }
resize(); addEventListener("resize",resize);

function lightning(){
  ctx.clearRect(0,0,c.width,c.height);
  for(let i=0;i<5;i++){
    const startX = Math.random()*c.width;
    const segments = Math.floor(Math.random()*10)+5;
    ctx.beginPath();
    ctx.moveTo(startX,0);
    for(let j=0;j<segments;j++){
      const x = startX + Math.random()*40 - 20;
      const y = (j/segments)*c.height;
      ctx.lineTo(x,y);
    }
    ctx.strokeStyle=`rgba(0,255,255,${Math.random()*0.4+0.1})`;
    ctx.lineWidth=1.2;
    ctx.shadowBlur=10;
    ctx.shadowColor="#0ff";
    ctx.stroke();
  }
}
setInterval(lightning,250);
</script>
</body>
</html>
