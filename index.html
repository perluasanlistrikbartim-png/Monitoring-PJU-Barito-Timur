<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TINJU ‚ö° Monitoring PJU Barito Timur</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: radial-gradient(circle at center, #000010, #000);
  color: #0ff;
  margin: 0;
}
header {
  display: flex; justify-content: space-between; align-items: center;
  padding: 12px 18px;
  background: linear-gradient(90deg, #0033ff, #00e6ff);
  color: #fff;
  box-shadow: 0 0 15px #00ffff;
}
h1 { font-size: 18px; margin: 0; }
#userInfo { display: flex; align-items: center; gap: 10px; }
#logoutBtn {
  background: linear-gradient(90deg, #ff0066, #ff6600);
  color: #fff; font-weight: 700; border: none;
  padding: 6px 12px; border-radius: 8px;
  box-shadow: 0 0 10px #ff3366;
  cursor: pointer;
}
#logoutBtn:hover { box-shadow: 0 0 20px #ff6600; }

.container {
  max-width: 1000px; margin: 20px auto; padding: 0 12px;
}
.card {
  background: rgba(0, 0, 25, 0.9);
  border: 2px solid #00ffff55;
  border-radius: 14px;
  padding: 16px;
  box-shadow: 0 0 20px #00ffff33;
  position: relative;
  margin-bottom: 20px;
  overflow: hidden;
}
.card::before {
  content: "";
  position: absolute; inset: -2px;
  border-radius: 16px;
  border: 2px solid #00ffff;
  filter: blur(10px);
  opacity: .45;
  animation: edge 3s linear infinite;
}
@keyframes edge { 0%,100%{opacity:.3} 50%{opacity:1} }

label { display: block; margin-top: 10px; font-weight: bold; }
input, select, textarea {
  width: 100%; padding: 8px;
  border: 1px solid #00ffff55;
  border-radius: 8px;
  background: #001122;
  color: #0ff;
}
button.primary {
  width: 100%; margin-top: 12px;
  background: linear-gradient(90deg, #0066ff, #00ffff);
  color: #000; font-weight: bold;
  border: none; padding: 10px;
  border-radius: 8px; cursor: pointer;
  box-shadow: 0 0 15px #00ffff;
}
button.primary:hover { box-shadow: 0 0 25px #00ffff; }

#map, #mapData {
  height: 300px;
  border-radius: 10px;
  margin-top: 8px;
  border: 1px solid #00ffff44;
}
#msg { text-align: center; margin-top: 8px; font-weight: 700; }
.grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
@media(min-width:900px){ .grid{grid-template-columns:1fr 1fr;} }

.legend { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
.badge {
  display: inline-flex; align-items: center; gap: 6px;
  background: #001828; border: 1px solid #00ffff44;
  border-radius: 999px; padding: 4px 10px;
}
.badge i { width: 10px; height: 10px; border-radius: 50%; }
</style>
</head>

<body>
<header>
  <h1>‚ö° TINJU ‚Äì Monitoring PJU Barito Timur</h1>
  <div id="userInfo">
    üë§ <span id="namaUser">Memuat...</span> (<span id="roleUser">-</span>)
    <button id="logoutBtn">Logout</button>
  </div>
</header>

<div class="container">
  <!-- Form Input -->
  <section class="card">
    <h3>üìù Input Laporan</h3>
    <label>Tanggal</label>
    <input type="date" id="tanggal" required>

    <label>Petugas</label>
    <input type="text" id="petugas" readonly required>

    <label>Nama Lokasi / Panel</label>
    <input type="text" id="lokasi" required placeholder="Contoh: Panel PJU Pasar Tamiang Layang">

    <label>Koordinat</label>
    <input type="text" id="koordinat" readonly required placeholder="üìç Ambil lokasi di peta atau tombol bawah">
    <div id="map"></div>
    <button type="button" class="primary" id="lokasiSaya">üìç Ambil Lokasi Saya</button>

    <label>Jenis Kerusakan</label>
    <select id="jenis" required>
      <option value="">Pilih Jenis</option>
      <option>Lampu</option>
      <option>Jaringan Kabel</option>
      <option>Kontroller/Proteksi</option>
      <option>Short Circuit</option>
      <option>Hilang Tegangan</option>
      <option>Tidak Diketahui</option>
    </select>

    <label>Keterangan</label>
    <textarea id="keterangan" rows="3"></textarea>

    <label>üì∏ Upload Foto</label>
    <input type="file" id="foto" accept="image/*" capture="environment">

    <button class="primary" id="submitBtn">‚úÖ Kirim Data</button>
    <div id="msg"></div>
  </section>

  <!-- Statistik -->
  <section class="card">
    <h3>üìä Statistik & Peta</h3>
    <div class="legend">
      <span class="badge"><i style="background:gold"></i> Lampu</span>
      <span class="badge"><i style="background:#ff4d4d"></i> Kabel</span>
      <span class="badge"><i style="background:#00e6ff"></i> Proteksi</span>
      <span class="badge"><i style="background:orange"></i> Short</span>
      <span class="badge"><i style="background:plum"></i> Hilang Tegangan</span>
      <span class="badge"><i style="background:#ddd"></i> Tidak Diketahui</span>
    </div>
    <div class="grid">
      <canvas id="chartJenis"></canvas>
      <div id="mapData"></div>
    </div>
  </section>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const proxy = "https://broad-queen-be12.perluasanlistrik-bartim.workers.dev/?url=";
const scriptURL = "https://script.google.com/macros/s/AKfycbwcMi_pBDlXeEzS5wxpIuiRmDjvkiwjgR53TmcfhGyi0DcKTSj3sgGXxfmPEpbVhUgg4g/exec";

window.addEventListener("DOMContentLoaded", () => {
  const nama = localStorage.getItem("petugas");
  const role = localStorage.getItem("role");
  if (!nama || !role) {
    localStorage.clear();
    window.location.href = "login.html";
    return;
  }

  document.getElementById("namaUser").textContent = nama;
  document.getElementById("roleUser").textContent = role;
  document.getElementById("logoutBtn").onclick = () => {
    localStorage.clear();
    window.location.href = "login.html";
  };

  document.getElementById("tanggal").value = new Date().toISOString().slice(0,10);
  document.getElementById("petugas").value = nama;

  initMaps(nama, role);
});

function initMaps(namaLogin, roleLogin) {
  // === PETA INPUT ===
  const map = L.map("map").setView([-2.13, 115.10], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  let marker;

  function setKoordinat(lat, lng, zoom) {
    document.getElementById("koordinat").value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    if (marker) map.removeLayer(marker);
    marker = L.marker([lat, lng]).addTo(map).bindPopup(`üìç ${lat.toFixed(6)}, ${lng.toFixed(6)}`).openPopup();
    if (zoom) map.setView([lat, lng], 17);
  }

  map.on("click", e => setKoordinat(e.latlng.lat, e.latlng.lng));
  document.getElementById("lokasiSaya").onclick = () => {
    if (!navigator.geolocation) return alert("Perangkat tidak mendukung GPS");
    navigator.geolocation.getCurrentPosition(
      pos => setKoordinat(pos.coords.latitude, pos.coords.longitude, true),
      () => alert("Tidak bisa mengambil lokasi")
    );
  };

  // === SUBMIT DATA ===
  document.getElementById("submitBtn").onclick = async () => {
    const koordinat = document.getElementById("koordinat").value.trim();
    if (!koordinat) return alert("‚ö†Ô∏è Ambil koordinat dulu!");

    let fotoBase64 = "";
    const file = document.getElementById("foto").files[0];
    if (file) {
      fotoBase64 = await new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    const data = {
      action: "upload",
      tanggal: document.getElementById("tanggal").value,
      petugas: namaLogin,
      lokasi: document.getElementById("lokasi").value,
      koordinat: koordinat,
      jenis: document.getElementById("jenis").value,
      keterangan: document.getElementById("keterangan").value,
      fotoBase64
    };

    const msg = document.getElementById("msg");
    msg.textContent = "‚è≥ Mengirim data...";
    try {
      const res = await fetch(proxy + scriptURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      const r = await res.json();
      msg.textContent = (r.status === "success")
        ? "‚úÖ Data tersimpan!"
        : "‚ö†Ô∏è Gagal: " + r.message;
      loadData(roleLogin, namaLogin);
    } catch {
      msg.textContent = "‚ùå Gagal koneksi!";
    }
  };

  // === OUTPUT DATA ===
  const mapData = L.map("mapData").setView([-2.13, 115.10], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapData);
  const layerGroup = L.layerGroup().addTo(mapData);
  let chartRef = null;

  async function loadData(role, petugas) {
    try {
      const res = await fetch(proxy + scriptURL);
      const data = await res.json();

      const rows = (role === "petugas") ? data.filter(d => d.petugas === petugas) : data;
      layerGroup.clearLayers();
      const counts = {};

      rows.forEach(d => {
        if (!d.koordinat) return;
        const [lat, lng] = d.koordinat.split(",").map(Number);
        const color = {
          "Lampu": "gold",
          "Jaringan Kabel": "#ff4d4d",
          "Kontroller/Proteksi": "#00e6ff",
          "Short Circuit": "orange",
          "Hilang Tegangan": "plum",
          "Tidak Diketahui": "#ccc"
        }[d.jenis] || "gray";

        const icon = L.divIcon({
          className: "custom-marker",
          html: `<div style="width:12px;height:12px;background:${color};border-radius:50%;box-shadow:0 0 8px ${color};"></div>`
        });
        L.marker([lat, lng], { icon }).addTo(layerGroup).bindPopup(`
          <b>${d.lokasi}</b><br>
          üßç ${d.petugas}<br>
          ‚öôÔ∏è ${d.jenis}<br>
          üìù ${d.keterangan}<br>
          ${d.foto ? `<a href="${d.foto}" target="_blank">üì∏ Foto</a>` : ""}
        `);

        counts[d.jenis] = (counts[d.jenis] || 0) + 1;
      });

      // Chart
      const ctx = document.getElementById("chartJenis").getContext("2d");
      if (chartRef) chartRef.destroy();
      chartRef = new Chart(ctx, {
        type: "bar",
        data: {
          labels: Object.keys(counts),
          datasets: [{ label: "Jumlah", data: Object.values(counts), backgroundColor: "#00ffffaa" }]
        },
        options: { plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });
    } catch (err) { console.error(err); }
  }

  loadData(roleLogin, namaLogin);
}
</script>
</body>
</html>
