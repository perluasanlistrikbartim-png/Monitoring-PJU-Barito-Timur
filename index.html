<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TINJU ‚ö° Digital Neon Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: radial-gradient(circle at 50% 20%, #050d18, #010308 80%);
  color: #d7faff;
  margin: 0;
}
header {
  text-align:center; padding:15px; font-size:1.3em; color:#00ffff;
  text-shadow:0 0 10px #00ffff;
  border-bottom:1px solid rgba(0,255,255,0.3);
}
form, #adminPanel {
  background:#0a1220; border:1px solid rgba(0,255,255,0.4);
  box-shadow:0 0 15px rgba(0,255,255,0.2);
  border-radius:10px; max-width:480px; margin:20px auto; padding:20px;
}
input, select, textarea {
  width:100%; padding:8px; border:1px solid #00ffff; border-radius:6px;
  background:#0a1220; color:#fff;
}
button {
  width:100%; background:linear-gradient(90deg,#0077ff,#00ffff);
  color:white; font-weight:bold; padding:10px; border:none; border-radius:6px;
  margin-top:10px; cursor:pointer;
}
#map,#mapData {height:300px;border-radius:10px;margin-top:10px;}
canvas {max-width:90%;margin:auto;display:block;}
</style>
</head>
<body>
<header>‚ö° Sistem Monitoring PJU ‚Äì TINJU</header>

<form id="tinjuForm">
  <label>Tanggal:</label><input type="date" id="tanggal" required>
  <label>Petugas:</label><input type="text" id="petugas" readonly>
  <label>Lokasi:</label><input type="text" id="lokasi" required>
  <label>Koordinat:</label><input type="text" id="koordinat" readonly required>
  <div id="map"></div>
  <button type="button" id="lokasiSaya">üìç Ambil Lokasi Saya</button>
  <label>Jenis:</label>
  <select id="jenis" required>
    <option value="">Pilih Jenis</option>
    <option value="Lampu">Lampu</option>
    <option value="Jaringan Kabel">Jaringan Kabel</option>
    <option value="Kontroller/Proteksi">Kontroller/Proteksi</option>
    <option value="Short Circuit">Short Circuit</option>
    <option value="Hilang Tegangan">Hilang Tegangan</option>
  </select>
  <label>Keterangan:</label><textarea id="keterangan"></textarea>
  <label>üì∏ Upload Foto:</label><input type="file" id="foto" accept="image/*">
  <button type="submit">‚úÖ Kirim Data</button>
</form>

<div id="msg"></div>

<div id="adminPanel" style="display:none;">
  <h2 style="text-align:center;color:#00ffff;">üìä Statistik Kerusakan</h2>
  <canvas id="chartKerusakan"></canvas>
  <h2 style="text-align:center;color:#00ffff;">üó∫Ô∏è Peta Semua Data</h2>
  <div id="mapData"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbwcMi_pBDlXeEzS5wxpIuiRmDjvkiwjgR53TmcfhGyi0DcKTSj3sgGXxfmPEpbVhUgg4g/exec";
const petugas = localStorage.getItem('petugas');
const role = localStorage.getItem('role');
if(!petugas) window.location.href='login.html';
document.getElementById('petugas').value = petugas;

// Peta input
const map = L.map('map').setView([-2.13,115.10],9);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let marker;
map.on('click',e=>{
  const lat=e.latlng.lat.toFixed(6);
  const lng=e.latlng.lng.toFixed(6);
  document.getElementById('koordinat').value=`${lat},${lng}`;
  if(marker)map.removeLayer(marker);
  marker=L.marker(e.latlng).addTo(map).bindPopup(`üìç ${lat},${lng}`).openPopup();
});

document.getElementById('lokasiSaya').onclick=()=>{
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude.toFixed(6);
    const lng=pos.coords.longitude.toFixed(6);
    document.getElementById('koordinat').value=`${lat},${lng}`;
    map.setView([lat,lng],17);
    if(marker)map.removeLayer(marker);
    marker=L.marker([lat,lng]).addTo(map).bindPopup("üìç Lokasi Anda").openPopup();
  });
};

// Submit data
document.getElementById('tinjuForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const file=document.getElementById('foto').files[0];
  let fotoBase64="";
  if(file){
    fotoBase64=await new Promise((res,rej)=>{
      const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(file);
    });
  }
  const data={
    action:'submit',
    tanggal:document.getElementById('tanggal').value,
    petugas,
    lokasi:document.getElementById('lokasi').value,
    koordinat:document.getElementById('koordinat').value,
    jenis:document.getElementById('jenis').value,
    keterangan:document.getElementById('keterangan').value,
    fotoBase64
  };
  document.getElementById('msg').innerHTML="‚ö° Mengirim data...";
  const res=await fetch(scriptURL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  const r=await res.json();
  document.getElementById('msg').innerHTML=r.status==="success"?"‚úÖ Data berhasil dikirim!":"‚ùå "+r.message;
  if(role==="admin") loadDashboard();
});

// === Dashboard Admin ===
if(role==="admin") {
  document.getElementById('adminPanel').style.display="block";
  loadDashboard();
}

async function loadDashboard(){
  const res = await fetch(scriptURL);
  const data = await res.json();
  // Peta Output
  const mapData = L.map('mapData').setView([-2.13,115.10],9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(mapData);
  data.forEach(d=>{
    if(!d.koordinat)return;
    const [lat,lng]=d.koordinat.split(',').map(Number);
    L.marker([lat,lng]).addTo(mapData)
      .bindPopup(`<b>${d.lokasi}</b><br>${d.petugas}<br>${d.jenis}`);
  });
  // Grafik Statistik
  const statsRes=await fetch(scriptURL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'stats'})});
  const s=await statsRes.json();
  const ctx=document.getElementById('chartKerusakan').getContext('2d');
  new Chart(ctx,{
    type:'bar',
    data:{labels:Object.keys(s.stats),datasets:[{
      label:'Jumlah Kerusakan',
      data:Object.values(s.stats),
      backgroundColor:'#00ffff80',
      borderColor:'#00ffff',
      borderWidth:1
    }]},
    options:{plugins:{legend:{labels:{color:'#00ffff'}}},scales:{x:{ticks:{color:'#00ffff'}},y:{ticks:{color:'#00ffff'}}}}
  });
}
</script>
</body>
</html>
