<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚ö° Dashboard TINJU PJU</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  margin:0;
  background:#000 radial-gradient(circle at center, #000010, #000);
  color:#0ff;
  overflow-x:hidden;
}
header {
  display:flex; justify-content:space-between; align-items:center;
  background:linear-gradient(90deg,#001,#003);
  color:#0ff;
  padding:10px 20px;
  box-shadow:0 0 15px #00ffff;
  position:relative;
}
header::after {
  content:"";
  position:absolute; inset:0;
  border:1px solid #00ffff44;
  box-shadow:0 0 25px #00ffff44 inset;
  animation:glow 3s infinite alternate;
}
@keyframes glow { from{opacity:.3} to{opacity:1} }
#logoutBtn {
  background:linear-gradient(90deg,#ff0066,#ff6600);
  box-shadow:0 0 10px #ff3366;
  border:none; color:#fff; font-weight:bold;
  padding:6px 14px; border-radius:8px; cursor:pointer;
}
#logoutBtn:hover { box-shadow:0 0 20px #ff6600; }

h2 { text-align:center; color:#00ffff; text-shadow:0 0 12px #00ffff; }

form {
  background:#001122;
  padding:15px;
  margin:15px auto;
  max-width:480px;
  border:2px solid #00ffff66;
  border-radius:12px;
  box-shadow:0 0 15px #00ffff55;
  position:relative;
}
form::before {
  content:"";
  position:absolute;
  inset:-2px;
  border-radius:14px;
  border:1px solid #00ffff44;
  filter:blur(4px);
  animation:spark 3s linear infinite;
}
@keyframes spark { 0%{opacity:.4} 50%{opacity:1} 100%{opacity:.4} }

label { display:block; margin-top:10px; font-weight:bold; }
input, select, textarea {
  width:100%;
  padding:8px;
  border-radius:6px;
  border:1px solid #00ffff44;
  background:#000814;
  color:#0ff;
}
button {
  width:100%;
  margin-top:10px;
  padding:10px;
  border:none;
  border-radius:8px;
  background:linear-gradient(90deg,#00ffff,#0077ff);
  font-weight:bold; color:#000;
  box-shadow:0 0 15px #00ffff55;
  cursor:pointer;
}
button:hover { box-shadow:0 0 25px #00ffff; }

#map, #mapData {
  height:300px;
  margin-top:10px;
  border-radius:8px;
}
#msg {
  text-align:center;
  margin-top:10px;
  font-weight:bold;
  color:#ffb86b;
}
</style>
</head>
<body>

<header>
  <div>‚ö° <b id="userName">Memuat...</b> (<span id="userRole">-</span>)</div>
  <button id="logoutBtn">Logout</button>
</header>

<h2>üìã Monitoring PJU Barito Timur</h2>

<form id="tinjuForm">
  <label>Tanggal:</label>
  <input type="date" id="tanggal" required>

  <label>Petugas:</label>
  <input type="text" id="petugas" readonly>

  <label>Lokasi:</label>
  <input type="text" id="lokasi" required>

  <label>Koordinat:</label>
  <input type="text" id="koordinat" required readonly placeholder="üìç Klik peta atau tekan Ambil Lokasi Saya">

  <div id="map"></div>
  <button type="button" id="lokasiSaya">üìç Ambil Lokasi Saya</button>

  <label>Jenis Kerusakan:</label>
  <select id="jenis" required>
    <option value="">Pilih Jenis</option>
    <option value="Lampu">Lampu</option>
    <option value="Jaringan Kabel">Jaringan Kabel</option>
    <option value="Kontroller/Proteksi">Kontroller/Proteksi</option>
    <option value="Short Circuit">Short Circuit</option>
    <option value="Hilang Tegangan">Hilang Tegangan</option>
    <option value="Tidak Diketahui">Tidak Diketahui</option>
  </select>

  <label>Keterangan:</label>
  <textarea id="keterangan" rows="3"></textarea>

  <label>üì∏ Foto:</label>
  <input type="file" id="foto" accept="image/*">

  <button type="submit">‚úÖ Kirim Data</button>
</form>

<div id="msg"></div>

<h2>üó∫Ô∏è Data PJU yang sudah masuk</h2>
<div id="mapData"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const proxy = "https://broad-queen-be12.perluasanlistrik-bartim.workers.dev/?url=";
const scriptURL = "https://script.google.com/macros/s/AKfycbwcMi_pBDlXeEzS5wxpIuiRmDjvkiwjgR53TmcfhGyi0DcKTSj3sgGXxfmPEpbVhUgg4g/exec";

// üîê Cek login
document.addEventListener("DOMContentLoaded", () => {
  const petugas = localStorage.getItem("petugas");
  const role = localStorage.getItem("role");

  if (!petugas || !role) {
    alert("‚ö†Ô∏è Anda belum login!");
    window.location.href = "login.html";
    return;
  }

  document.getElementById("userName").textContent = petugas;
  document.getElementById("userRole").textContent = role;
  document.getElementById("petugas").value = petugas;
});

// üö™ Logout
document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.clear();
  window.location.href = "login.html";
});

// üåç Peta Input
const map = L.map("map").setView([-2.13, 115.10], 9);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);
let marker;

map.on("click", e => {
  const lat = e.latlng.lat.toFixed(6);
  const lng = e.latlng.lng.toFixed(6);
  document.getElementById("koordinat").value = `${lat}, ${lng}`;
  if (marker) map.removeLayer(marker);
  marker = L.marker(e.latlng).addTo(map).bindPopup(`üìç ${lat}, ${lng}`).openPopup();
});

document.getElementById("lokasiSaya").addEventListener("click", () => {
  if (!navigator.geolocation) return alert("GPS tidak didukung.");
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude.toFixed(6);
    const lng = pos.coords.longitude.toFixed(6);
    document.getElementById("koordinat").value = `${lat}, ${lng}`;
    map.setView([lat, lng], 17);
    if (marker) map.removeLayer(marker);
    marker = L.marker([lat, lng]).addTo(map).bindPopup("üìç Lokasi Anda").openPopup();
  });
});

// üì§ Kirim Data
document.getElementById("tinjuForm").addEventListener("submit", async e => {
  e.preventDefault();
  const koor = document.getElementById("koordinat").value.trim();
  if (!koor) return alert("‚ö†Ô∏è Koordinat wajib diisi!");
  const foto = document.getElementById("foto").files[0];
  let base64 = "";
  if (foto) {
    base64 = await new Promise((res, rej) => {
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = rej;
      r.readAsDataURL(foto);
    });
  }
  const data = {
    action: "upload",
    tanggal: document.getElementById("tanggal").value,
    petugas: document.getElementById("petugas").value,
    lokasi: document.getElementById("lokasi").value,
    koordinat: koor,
    jenis: document.getElementById("jenis").value,
    keterangan: document.getElementById("keterangan").value,
    fotoBase64: base64
  };
  document.getElementById("msg").textContent = "‚è≥ Mengirim data...";
  try {
    const res = await fetch(proxy + scriptURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    const r = await res.json();
    if (r.status === "success") {
      document.getElementById("msg").textContent = "‚úÖ Data berhasil dikirim!";
      loadData();
    } else {
      document.getElementById("msg").textContent = "‚ö†Ô∏è " + r.message;
    }
  } catch (err) {
    document.getElementById("msg").textContent = "‚ùå Gagal koneksi.";
  }
});

// üìä Peta Data Output
const mapData = L.map("mapData").setView([-2.13, 115.10], 9);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(mapData);

async function loadData() {
  try {
    const res = await fetch(proxy + scriptURL);
    const data = await res.json();
    mapData.eachLayer(l => { if (l instanceof L.Marker) mapData.removeLayer(l); });
    data.forEach(d => {
      if (!d.koordinat) return;
      const [lat, lng] = d.koordinat.split(",").map(Number);
      const popup = `
        <b>${d.lokasi}</b><br>
        üßç ${d.petugas}<br>
        üìÖ ${d.tanggal}<br>
        ‚öôÔ∏è ${d.jenis}<br>
        üìù ${d.keterangan}<br>
        ${d.foto ? `<a href="${d.foto}" target="_blank">üì∏ Lihat Foto</a>` : ""}
      `;
      const icon = L.icon({
        iconUrl: d.jenis.includes("Lampu") ? "https://cdn-icons-png.flaticon.com/512/1078/1078429.png"
                : d.jenis.includes("Jaringan") ? "https://cdn-icons-png.flaticon.com/512/102/102649.png"
                : "https://cdn-icons-png.flaticon.com/512/484/484167.png",
        iconSize: [28, 28]
      });
      L.marker([lat, lng], { icon }).addTo(mapData).bindPopup(popup);
    });
  } catch (err) {
    console.error(err);
  }
}

loadData();
</script>
</body>
</html>
