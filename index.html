<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚ö° Monitoring PJU ‚Äì Barito Timur</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body {
  font-family: 'Segoe UI', sans-serif;
  margin: 0;
  background: radial-gradient(circle at center, #000020, #000);
  color: #0ff;
  overflow-x: hidden;
  position: relative;
}
header {
  text-align: center;
  padding: 16px 10px;
  background: linear-gradient(90deg,#001122,#003344);
  color: #0ff;
  font-weight: bold;
  font-size: 1.1rem;
  text-shadow: 0 0 8px #00ffffaa;
  box-shadow: 0 0 25px #00ffff55;
  position: relative;
  z-index: 3;
}
form {
  background: rgba(0,15,25,.9);
  border: 1px solid #00ffff55;
  border-radius: 14px;
  box-shadow: 0 0 20px #00ffff44;
  padding: 20px;
  margin: 0 auto 20px;
  max-width: 480px;
  width: 90%;
  position: relative;
  z-index: 2;
}
label {display:block;margin-top:10px;font-weight:bold;}
input, select, textarea {
  width: 100%;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #00ffff44;
  background: #000814;
  color: #0ff;
  font-size: 14px;
}
button {
  width: 100%;
  background: linear-gradient(90deg,#00ffff,#0077ff);
  color:#000;
  font-weight:bold;
  border:none;
  border-radius:6px;
  padding:10px;
  margin-top:10px;
  cursor:pointer;
  box-shadow:0 0 15px #00ffff66;
  transition:0.2s;
}
button:hover{box-shadow:0 0 25px #00ffff;}
#msg{text-align:center;margin-top:10px;font-weight:bold;color:#0ff;}
.preview-area {
  display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;
}
.preview-item {
  position:relative;
}
.preview-item img {
  width:80px; height:80px;
  object-fit:cover;
  border:1px solid #00ffff55;
  border-radius:6px;
}
.preview-item span {
  position:absolute;
  top:-6px; right:-6px;
  background:#f00; color:#fff;
  font-size:10px;
  padding:2px 5px;
  border-radius:50%;
  cursor:pointer;
  box-shadow:0 0 5px #000;
}
#map,#mapData{height:320px;margin-top:10px;border-radius:10px;z-index:2;}
canvas#electricFX{position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:1;opacity:.5;}
  /* ====== HERO IMAGE DI ATAS HEADER ====== */
.hero {
  position: relative;
  width: 100%;
  height: 180px;
  overflow: hidden;
  background: radial-gradient(circle at center, #001122, #000);
  box-shadow: 0 0 30px #00ffff55 inset;
}

.hero img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  opacity: 0.8;
  animation: zoomPulse 12s ease-in-out infinite;
  filter: drop-shadow(0 0 20px #00ffffaa);
}

@keyframes zoomPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.08); }
}

/* Tambahan efek cahaya tipis */
.hero::after {
  content: "";
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: radial-gradient(circle at center, transparent 40%, rgba(0,255,255,0.1));
  animation: glowPulse 8s ease-in-out infinite;
}

@keyframes glowPulse {
  0%, 100% { opacity: 0.3; }
  50% { opacity: 0.6; }
}

</style>
</head>

<body>
<canvas id="electricFX"></canvas>
<header>‚ö° <b>Monitoring PJU Barito Timur</b></header>

<h2 style="text-align:center;text-shadow:0 0 12px #00ffff;">üìã Form Monitoring PJU</h2>

<form id="tinjuForm">
  <label>Tanggal:</label>
  <input type="date" id="tanggal" required>

  <label>Petugas:</label>
  <select id="petugas" required>
    <optgroup label="Petugas Dinas">
      <option value="Septeriady Ngubel">Septeriady Ngubel</option>
      <option value="Kwartino Handriano">Kwartino Handriano</option>
      <option value="Pawaino">Pawaino</option>
      <option value="M. Rizki">M. Rizki</option>
      <option value="Andri Karawaheno">Andri Karawaheno</option>
      <option value="Denni Widyatsan">Denni Widyatsan</option>
    </optgroup>
    <optgroup label="Petugas Teknisi">
      <option value="Ferry Andinata">Ferry Andinata</option>
      <option value="Randelson Randin">Randelson Randin</option>
      <option value="Muharman">Muharman</option>
    </optgroup>
  </select>

  <label>Lokasi Panel:</label>
  <input type="text" id="lokasi" required placeholder="Contoh: Panel PJU Nansarunai">

  <label>Koordinat:</label>
  <input type="text" id="koordinat" readonly required placeholder="üìç Klik peta atau 'Ambil Lokasi Saya'">
  <div id="map"></div>
  <button type="button" id="lokasiSaya">üìç Ambil Lokasi Saya</button>

  <label>Jenis Kerusakan:</label>
  <select id="jenis" required>
    <option value="">Pilih Jenis</option>
    <option>Lampu</option><option>Jaringan Kabel</option>
    <option>Kontroller/Proteksi</option><option>Short Circuit</option>
    <option>Hilang Tegangan</option><option>Tidak Diketahui</option>
  </select>

  <label>Keterangan:</label>
  <textarea id="keterangan" rows="3" placeholder="Tuliskan kondisi / catatan tambahan..."></textarea>

  <label>üì∏ Foto Lokasi:</label>
  <div id="fotoArea">
    <input type="file" class="fotoInput" accept="image/*">
  </div>
  <div class="preview-area" id="previewArea"></div>
  <button type="button" id="addFotoBtn">+ Tambah Foto Lagi</button>

  <button type="submit">‚úÖ Kirim Data</button>
</form>

<div id="msg"></div>

<h2 style="text-align:center;text-shadow:0 0 12px #00ffff;">üó∫Ô∏è Peta Data PJU</h2>
<div id="mapData"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const PROXY="https://broad-queen-be12.perluasanlistrik-bartim.workers.dev/?url=";
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbwcMi_pBDlXeEzS5wxpIuiRmDjvkiwjgR53TmcfhGyi0DcKTSj3sgGXxfmPEpbVhUgg4g/exec";
let fotoFiles=[];

// tambah foto input baru
document.getElementById("addFotoBtn").addEventListener("click",()=>{
  const input=document.createElement("input");
  input.type="file"; input.accept="image/*"; input.className="fotoInput";
  input.addEventListener("change",handleFotoSelect);
  document.getElementById("fotoArea").appendChild(input);
});

// handle setiap file yang dipilih
function handleFotoSelect(e){
  const file=e.target.files[0];
  if(!file)return;
  fotoFiles.push(file);
  const reader=new FileReader();
  reader.onload=()=>{
    const div=document.createElement("div");
    div.className="preview-item";
    div.innerHTML=`<img src="${reader.result}"><span>√ó</span>`;
    div.querySelector("span").onclick=()=>{
      div.remove();
      fotoFiles=fotoFiles.filter(f=>f!==file);
    };
    document.getElementById("previewArea").appendChild(div);
  };
  reader.readAsDataURL(file);
}
document.querySelector(".fotoInput").addEventListener("change",handleFotoSelect);

// === Map input ===
const map=L.map('map').setView([-2.13,115.10],9);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let marker;
map.on('click',e=>{
  const lat=e.latlng.lat.toFixed(6);
  const lng=e.latlng.lng.toFixed(6);
  document.getElementById('koordinat').value=`${lat},${lng}`;
  if(marker)map.removeLayer(marker);
  marker=L.marker(e.latlng).addTo(map).bindPopup(`üìç ${lat},${lng}`).openPopup();
});
document.getElementById("lokasiSaya").onclick=()=>{
  if(!navigator.geolocation)return alert("GPS tidak didukung browser ini.");
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude.toFixed(6);
    const lng=pos.coords.longitude.toFixed(6);
    document.getElementById('koordinat').value=`${lat},${lng}`;
    map.setView([lat,lng],17);
    if(marker)map.removeLayer(marker);
    marker=L.marker([lat,lng]).addTo(map).bindPopup("üìç Lokasi Anda").openPopup();
  },()=>alert("Gagal mengambil lokasi."));
};

// === Submit ===
document.getElementById("tinjuForm").addEventListener("submit",async e=>{
  e.preventDefault();
  if(fotoFiles.length===0)return alert("Tambahkan minimal 1 foto.");
  const fotoBase64List=await Promise.all(fotoFiles.map(file=>new Promise((res,rej)=>{
    const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(file);
  })));
  const data={
    action:"upload",
    tanggal:document.getElementById("tanggal").value,
    petugas:document.getElementById("petugas").value,
    lokasi:document.getElementById("lokasi").value,
    koordinat:document.getElementById("koordinat").value,
    jenis:document.getElementById("jenis").value,
    keterangan:document.getElementById("keterangan").value,
    fotoBase64List
  };
  document.getElementById("msg").textContent="‚ö° Mengirim data...";
  const res=await fetch(PROXY+SCRIPT_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});
  const r=await res.json();
  if(r.status==="success"){
    document.getElementById("msg").textContent="‚úÖ Data berhasil dikirim!";
    document.getElementById("tinjuForm").reset();
    document.getElementById("previewArea").innerHTML="";
    fotoFiles=[];
    loadData();
  }else document.getElementById("msg").textContent="‚ö†Ô∏è "+r.message;
});

// === Map Output ===
const mapData=L.map("mapData").setView([-2.13,115.10],9);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(mapData);
async function loadData(){
  const res=await fetch(PROXY+SCRIPT_URL);
  const data=await res.json();
  mapData.eachLayer(l=>{if(l instanceof L.Marker)mapData.removeLayer(l);});
  data.forEach(d=>{
    if(!d.koordinat)return;
    const [lat,lng]=d.koordinat.split(",").map(Number);
    const fotos=Array.isArray(d.foto)?d.foto:[d.foto];
    const links=fotos.filter(Boolean).map((f,i)=>`<a href="${f}" target="_blank">üì∏ Foto ${i+1}</a>`).join("<br>");
    const popup=`<b>${d.lokasi}</b><br>üßç ${d.petugas}<br>üìÖ ${d.tanggal}<br>‚öôÔ∏è ${d.jenis}<br>üìù ${d.keterangan}<br>${links}`;
    const icon=L.divIcon({html:`<span style='color:#0ff;font-size:20px;text-shadow:0 0 10px #00ffff;'>‚ö°</span>`,className:""});
    L.marker([lat,lng],{icon}).addTo(mapData).bindPopup(popup);
  });
}
loadData();

// === Efek Kilat ===
const c=document.getElementById("electricFX");const ctx=c.getContext("2d");
function resize(){c.width=innerWidth;c.height=innerHeight;}
resize();addEventListener("resize",resize);
function lightning(){
  ctx.clearRect(0,0,c.width,c.height);
  for(let i=0;i<4;i++){
    const sx=Math.random()*c.width;const seg=8;
    ctx.beginPath();ctx.moveTo(sx,0);
    for(let j=0;j<seg;j++){
      const x=sx+Math.random()*40-20;
      const y=(j/seg)*c.height;
      ctx.lineTo(x,y);
    }
    ctx.strokeStyle=`rgba(0,255,255,${Math.random()*0.4+0.1})`;
    ctx.lineWidth=1.2;ctx.shadowBlur=12;ctx.shadowColor="#0ff";ctx.stroke();
  }
}
setInterval(lightning,250);
</script>
</body>
</html>

