<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TINJU – Monitoring PJU Barito Timur</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>
body { font-family: Arial, sans-serif; background:#f4f6f9; margin:0; }
h2 { background:#1976d2; color:#fff; padding:10px; text-align:center; }
form { background:#fff; margin:20px auto; max-width:480px; padding:20px;
       border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
label { display:block; margin-top:10px; font-weight:bold; }
input, select, textarea {
  width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; font-size:14px;
}
button { width:100%; background:#1976d2; color:#fff; border:none; padding:10px;
          border-radius:6px; font-weight:bold; cursor:pointer; margin-top:10px; }
button:hover { background:#0d47a1; }
#map, #mapData { height:320px; border-radius:6px; margin-top:10px; }
#msg { text-align:center; margin-top:10px; font-weight:bold; }
#progressBar { width:100%; background:#eee; border-radius:6px; overflow:hidden; height:10px; margin-top:5px; display:none; }
#progress { width:0; height:10px; background:#1976d2; transition:width 0.3s; }
</style>
</head>

<body>
<h2>📋 Monitoring PJU (TINJU) – Kabupaten Barito Timur</h2>

<form id="tinjuForm" enctype="multipart/form-data">
  <label>Tanggal:</label>
  <input type="date" id="tanggal" required>

  <label>Petugas:</label>
  <input type="text" id="petugas" required placeholder="Nama lengkap">

  <label>Nama Lokasi / Panel:</label>
  <input type="text" id="lokasi" required placeholder="Contoh: Panel PJU Pasar Tamiang Layang">

  <label>Koordinat:</label>
  <input type="text" id="koordinat" readonly required>

  <div id="map"></div>
  <button type="button" id="lokasiSaya">📍 Ambil Lokasi Saya</button>

  <label>Jenis Kerusakan:</label>
  <select id="jenis" required>
    <option value="">Pilih Jenis Kerusakan</option>
    <option value="Lampu">Lampu</option>
    <option value="Jaringan Kabel">Jaringan Kabel</option>
    <option value="Kontroller/Proteksi">Kontroller/Proteksi</option>
    <option value="Short Circuit">Short Circuit</option>
    <option value="Hilang Tegangan">Hilang Tegangan</option>
    <option value="Tidak Diketahui">Tidak Diketahui</option>
  </select>

  <label>Keterangan:</label>
  <textarea id="keterangan" rows="3"></textarea>

  <label>📸 Upload Foto Lokasi:</label>
<input type="file" id="foto" name="foto" accept="image/*" capture="environment"
 style="display:block;cursor:pointer;background:#fafafa;border:1px solid #ccc;padding:5px;border-radius:6px;"
 onchange="fileDipilih(this)">
<small>📷 Pilih dari galeri atau ambil foto langsung</small>

<script>
function fileDipilih(el){
  if(el.files.length>0){
    document.getElementById('msg').innerHTML = "📸 Foto dipilih: " + el.files[0].name;
  }
}
</script>

  <div id="progressBar"><div id="progress"></div></div>

  <button type="submit">✅ Kirim Data</button>
</form>

<div id="msg"></div>

<h2>🗺️ Data PJU yang sudah masuk</h2>
<div id="mapData"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbwcMi_pBDlXeEzS5wxpIuiRmDjvkiwjgR53TmcfhGyi0DcKTSj3sgGXxfmPEpbVhUgg4g/exec";

window.onload = () => {
  // === PETA INPUT ===
  const map = L.map('map').setView([-2.13, 115.10], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
  let marker;

  map.on('click', e => {
    const lat = e.latlng.lat.toFixed(6);
    const lng = e.latlng.lng.toFixed(6);
    document.getElementById('koordinat').value = `${lat}, ${lng}`;
    document.getElementById('koordinat').style.borderColor = "#ccc";
    if (marker) map.removeLayer(marker);
    marker = L.marker(e.latlng).addTo(map).bindPopup(`📍 ${lat}, ${lng}`).openPopup();
  });

  document.getElementById('lokasiSaya').addEventListener('click', () => {
    if (!navigator.geolocation) return alert("GPS tidak didukung browser ini.");
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude.toFixed(6);
      const lng = pos.coords.longitude.toFixed(6);
      map.setView([lat, lng], 17);
      document.getElementById('koordinat').value = `${lat}, ${lng}`;
      document.getElementById('koordinat').style.borderColor = "#ccc";
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map)
        .bindPopup(`📍 Lokasi Anda<br>${lat}, ${lng}`).openPopup();
    }, () => alert("Gagal mendapatkan lokasi."));
  });

  // === KIRIM DATA ===
  document.getElementById('tinjuForm').addEventListener('submit', async e => {
    e.preventDefault();

    // 🧭 Validasi koordinat wajib diisi
    const koordinatValue = document.getElementById('koordinat').value.trim();
    if (!koordinatValue) {
      const koorInput = document.getElementById('koordinat');
      koorInput.style.borderColor = "red";
      document.getElementById('msg').innerHTML = "⚠️ Harap ambil koordinat lokasi terlebih dahulu!";
      koorInput.focus();
      return;
    }

    const formData = new FormData();
    const fotoFile = document.getElementById('foto').files[0];
    const progressBar = document.getElementById('progressBar');
    const progress = document.getElementById('progress');
    formData.append('data', JSON.stringify({
      tanggal: document.getElementById('tanggal').value,
      petugas: document.getElementById('petugas').value,
      lokasi: document.getElementById('lokasi').value,
      koordinat: koordinatValue,
      jenis: document.getElementById('jenis').value,
      keterangan: document.getElementById('keterangan').value
    }));
    if (fotoFile) formData.append('foto', fotoFile);
    // Jika ingin wajib upload foto: hapus komentar di bawah
    // else { alert("⚠️ Harap upload foto lokasi terlebih dahulu!"); return; }

    progressBar.style.display = 'block';
    progress.style.width = '20%';
    try {
      const res = await fetch(scriptURL, { method: 'POST', body: formData });
      progress.style.width = '60%';
      const r = await res.json();
      if (r.status === "success") {
        progress.style.width = '100%';
        document.getElementById('msg').innerHTML = "✅ Data & foto berhasil dikirim!";
        e.target.reset();
        loadData();
      } else {
        document.getElementById('msg').innerHTML = "⚠️ Gagal: " + r.message;
      }
    } catch (err) {
      document.getElementById('msg').innerHTML = "❌ Gagal kirim: " + err;
    } finally {
      setTimeout(() => { progressBar.style.display = 'none'; progress.style.width = '0'; }, 1500);
    }
  });

  // === PETA DATA (OUTPUT) ===
  const mapData = L.map('mapData').setView([-2.13, 115.10], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(mapData);

  async function loadData() {
    try {
      const res = await fetch(scriptURL);
      const data = await res.json();
      mapData.eachLayer(l => { if (l instanceof L.Marker) mapData.removeLayer(l); });
      data.forEach(d => {
        if (!d.koordinat) return;
        const [lat, lng] = d.koordinat.split(",").map(Number);
        const popup = `
          <b>${d.lokasi}</b><br>
          🧍 ${d.petugas}<br>
          📅 ${d.tanggal}<br>
          ⚙️ ${d.jenis}<br>
          📝 ${d.keterangan}<br>
          ${d.foto ? `<a href="${d.foto}" target="_blank">📸 Lihat Foto</a>` : ''}
        `;
        L.marker([lat, lng]).addTo(mapData).bindPopup(popup);
      });
    } catch (err) {
      console.error("Gagal memuat data:", err);
    }
  }

  loadData();
};
</script>
</body>
</html>

