<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TINJU – Monitoring PJU Barito Timur</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>
body {
  background: radial-gradient(circle at center, #000814, #000);
  font-family: 'Poppins', sans-serif;
  margin: 0; color: #fff;
}
h2 {
  background: linear-gradient(90deg, #00ffff44, #007bff33);
  color: #00ffff;
  text-align: center;
  padding: 10px;
  text-shadow: 0 0 10px #00ffff;
}
form {
  background: rgba(0,0,0,0.6);
  border: 1px solid #00ffff55;
  box-shadow: 0 0 20px #00ffff33;
  margin: 20px auto;
  max-width: 500px;
  padding: 20px;
  border-radius: 10px;
}
label { display:block; margin-top:10px; font-weight:bold; color:#0ff; }
input, select, textarea {
  width: 100%;
  padding: 8px;
  border: 1px solid #00ffff33;
  border-radius: 6px;
  background: rgba(0,0,0,0.5);
  color: #fff;
}
button {
  width: 100%;
  margin-top: 15px;
  padding: 10px;
  border: none;
  border-radius: 6px;
  background: linear-gradient(90deg, #00ffff, #007bff);
  color: #000;
  font-weight: bold;
  cursor: pointer;
}
button:hover {
  box-shadow: 0 0 20px #00ffff;
}
#map, #mapData {
  height: 320px;
  border-radius: 10px;
  margin-top: 10px;
}
#msg { text-align:center; margin-top:10px; font-weight:bold; color:#ff0; }
.preview {
  width: 100%;
  max-height: 200px;
  border-radius: 10px;
  margin-top: 5px;
  display:none;
}
</style>
</head>
<body>
<h2>⚡ Sistem TINJU PJU – Barito Timur</h2>

<form id="tinjuForm">
  <label>Tanggal:</label>
  <input type="date" id="tanggal" required>

  <label>Petugas:</label>
  <input type="text" id="petugas" required readonly>

  <label>Lokasi / Panel:</label>
  <input type="text" id="lokasi" required placeholder="Contoh: Panel PJU Pasar Tamiang Layang">

  <label>Koordinat:</label>
  <input type="text" id="koordinat" readonly required>
  <div id="map"></div>
  <button type="button" id="lokasiSaya">📍 Ambil Lokasi</button>

  <label>Jenis Kerusakan:</label>
  <select id="jenis" required>
    <option value="">Pilih Jenis</option>
    <option value="Lampu">Lampu</option>
    <option value="Jaringan Kabel">Jaringan Kabel</option>
    <option value="Kontroller/Proteksi">Kontroller/Proteksi</option>
    <option value="Short Circuit">Short Circuit</option>
    <option value="Hilang Tegangan">Hilang Tegangan</option>
  </select>

  <label>Keterangan:</label>
  <textarea id="keterangan" rows="3"></textarea>

  <label>📸 Upload Foto Lokasi:</label>
  <input type="file" id="foto" accept="image/*">
  <img id="preview" class="preview">

  <button type="submit">✅ Kirim Data</button>
</form>

<div id="msg"></div>
<h2>🗺️ Peta Data PJU</h2>
<div id="mapData"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const proxyURL = "https://broad-queen-be12.perluasanlistrik-bartim.workers.dev/?url=";
const scriptURL = "https://script.google.com/macros/s/AKfycbwcMi_pBDlXeEzS5wxpIuiRmDjvkiwjgR53TmcfhGyi0DcKTSj3sgGXxfmPEpbVhUgg4g/exec";

document.addEventListener("DOMContentLoaded", () => {
  const user = localStorage.getItem("petugas") || "";
  const role = localStorage.getItem("role") || "";
  if (!user) window.location.href = "login.html";
  document.getElementById("petugas").value = user;
  document.getElementById("tanggal").valueAsDate = new Date();

  const map = L.map('map').setView([-2.13, 115.10], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  let marker;

  map.on('click', e => {
    const lat = e.latlng.lat.toFixed(6);
    const lng = e.latlng.lng.toFixed(6);
    document.getElementById('koordinat').value = `${lat}, ${lng}`;
    if (marker) map.removeLayer(marker);
    marker = L.marker(e.latlng).addTo(map).bindPopup(`📍 ${lat}, ${lng}`).openPopup();
  });

  document.getElementById("lokasiSaya").addEventListener("click", () => {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude.toFixed(6);
      const lng = pos.coords.longitude.toFixed(6);
      document.getElementById('koordinat').value = `${lat}, ${lng}`;
      map.setView([lat, lng], 17);
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map)
        .bindPopup(`📍 Lokasi Anda<br>${lat}, ${lng}`).openPopup();
    }, () => alert("Gagal ambil lokasi"));
  });

  const fotoInput = document.getElementById("foto");
  const preview = document.getElementById("preview");
  fotoInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = ev => {
        preview.src = ev.target.result;
        preview.style.display = "block";
      };
      reader.readAsDataURL(file);
    }
  });

  document.getElementById("tinjuForm").addEventListener("submit", async e => {
    e.preventDefault();
    const file = fotoInput.files[0];
    let fotoBase64 = "";
    if (file) fotoBase64 = await new Promise(r => {
      const fr = new FileReader(); fr.onload = () => r(fr.result); fr.readAsDataURL(file);
    });

    const data = {
      action: "upload",
      tanggal: document.getElementById("tanggal").value,
      petugas: user,
      lokasi: document.getElementById("lokasi").value,
      koordinat: document.getElementById("koordinat").value,
      jenis: document.getElementById("jenis").value,
      keterangan: document.getElementById("keterangan").value,
      fotoBase64
    };

    const msg = document.getElementById("msg");
    msg.innerHTML = "⚡ Mengirim data...";
    try {
      const res = await fetch(proxyURL + scriptURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      const r = await res.json();
      if (r.status === "success") {
        msg.innerHTML = "✅ Data & foto berhasil dikirim!";
        e.target.reset();
        preview.style.display = "none";
        loadData();
      } else msg.innerHTML = "⚠️ " + r.message;
    } catch (err) {
      msg.innerHTML = "❌ Gagal kirim: " + err;
    }
  });

  const mapData = L.map('mapData').setView([-2.13, 115.10], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapData);

  async function loadData() {
    const res = await fetch(proxyURL + scriptURL);
    const data = await res.json();
    mapData.eachLayer(l => { if (l instanceof L.Marker) mapData.removeLayer(l); });
    data.forEach(d => {
      if (!d.koordinat) return;
      const [lat, lng] = d.koordinat.split(",").map(Number);
      const popup = `<b>${d.lokasi}</b><br>🧍 ${d.petugas}<br>📅 ${d.tanggal}<br>⚙️ ${d.jenis}<br>📝 ${d.keterangan}<br>${d.foto ? `<a href="${d.foto}" target="_blank">📸 Foto</a>` : ''}`;
      L.marker([lat, lng]).addTo(mapData).bindPopup(popup);
    });
  }
  loadData();
});
</script>
</body>
</html>
