<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TINJU ‚Äì Monitoring PJU Barito Timur</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f7fb;
  margin: 0;
  padding: 0;
}
h2 {
  text-align: center;
  background: #1976d2;
  color: white;
  padding: 10px;
  margin: 0;
}
form {
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  max-width: 460px;
  margin: 20px auto;
}
label { display:block; margin-top:10px; font-weight:bold; }
input, select, textarea {
  width: 100%;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 14px;
}
button {
  margin-top: 10px;
  width: 100%;
  padding: 10px;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  color: white;
  background: #1976d2;
  cursor: pointer;
}
button:hover { background: #0d47a1; }
#map {
  height: 320px;
  border-radius: 10px;
  margin-top: 10px;
  border: 1px solid #aaa;
}
#msg { text-align: center; margin-top: 10px; font-weight: bold; }
</style>
</head>
<body>

<h2>üìã Monitoring PJU (TINJU) ‚Äì Kabupaten Barito Timur</h2>

<form id="tinjuForm">
  <label>Tanggal Pemeriksaan:</label>
  <input type="date" id="tanggal" required>

  <label>Nama Petugas:</label>
  <input type="text" id="petugas" placeholder="Nama lengkap" required>

  <label>Nama Lokasi / Panel PJU:</label>
  <input type="text" id="lokasi" placeholder="Contoh: Panel PJU Pasar Tamiang Layang" required>

  <label>Koordinat Lokasi:</label>
  <input type="text" id="koordinat" readonly required>
  <div id="map"></div>

  <button type="button" id="lokasiSaya">üìç Ambil Lokasi Saya</button>

  <label>Jenis Kerusakan:</label>
  <select id="jenis" required>
    <option value="">Pilih Jenis Kerusakan</option>
    <option value="Lampu">Lampu</option>
    <option value="Jaringan Kabel">Jaringan Kabel</option>
    <option value="Alat Proteksi & Kontroller">Alat Proteksi & Kontroller</option>
    <option value="Short Circuit">Short Circuit</option>
    <option value="Hilang Tegangan Sebelum KWh Meter">Hilang Tegangan Sebelum KWh Meter</option>
    <option value="Tidak Diketahui Kerusakannya">Tidak Diketahui Kerusakannya</option>
  </select>

  <label>Keterangan:</label>
  <textarea id="keterangan" rows="3"></textarea>

  <label>üì∏ Foto Lokasi:</label>
  <input type="file" id="foto" accept="image/*" capture="camera">

  <button type="submit">‚úÖ Kirim Data</button>
</form>

<div id="msg"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// === KONFIGURASI ===
const scriptURL = "https://script.google.com/macros/s/AKfycbwcMi_pBDlXeEzS5wxpIuiRmDjvkiwjgR53TmcfhGyi0DcKTSj3sgGXxfmPEpbVhUgg4g/exec";        // URL WebApp dari Apps Script

window.onload = () => {
  // === PETA INPUT ===
  const map = L.map('map').setView([-2.13, 115.10], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap'
  }).addTo(map);
  let marker;

  // Klik peta manual
  map.on('click', e => {
    const lat = e.latlng.lat.toFixed(6);
    const lng = e.latlng.lng.toFixed(6);
    document.getElementById('koordinat').value = `${lat}, ${lng}`;
    if (marker) map.removeLayer(marker);
    marker = L.marker(e.latlng).addTo(map).bindPopup(`üìç ${lat}, ${lng}`).openPopup();
  });

  // Tombol Lokasi Saya di bawah peta
  document.getElementById('lokasiSaya').addEventListener('click', () => {
    if (!navigator.geolocation) return alert("GPS tidak didukung browser ini.");
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude.toFixed(6);
      const lng = pos.coords.longitude.toFixed(6);
      map.setView([lat, lng], 17);
      document.getElementById('koordinat').value = `${lat}, ${lng}`;
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map).bindPopup(`üìç Lokasi Anda<br>${lat}, ${lng}`).openPopup();
    }, () => {
      alert("Gagal mendapatkan lokasi. Aktifkan GPS atau izinkan lokasi.");
    });
  });

  // === KIRIM DATA ===
document.getElementById('tinjuForm').addEventListener('submit', e => {
  e.preventDefault();

  const data = {
    tanggal: document.getElementById('tanggal').value,
    petugas: document.getElementById('petugas').value,
    lokasi: document.getElementById('lokasi').value,
    koordinat: document.getElementById('koordinat').value,
    jenis: document.getElementById('jenis').value,
    keterangan: document.getElementById('keterangan').value
  };

  fetch(scriptURL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(async r => {
    let res;
    try { res = await r.json(); }
    catch { throw new Error("Respon bukan JSON"); }

    if (res.status === "success") {
      document.getElementById('msg').innerHTML = "‚úÖ Data berhasil dikirim!";
      e.target.reset();
    } else {
      document.getElementById('msg').innerHTML = "‚ö†Ô∏è " + res.message;
    }
  })
  .catch(err => {
    console.error("Kesalahan:", err);
    document.getElementById('msg').innerHTML = "‚ùå Gagal mengirim data!";
  });
});

};
</script>
</body>
</html>

