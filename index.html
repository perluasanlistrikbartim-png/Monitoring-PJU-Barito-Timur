<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TINJU v4 – Monitoring PJU Barito Timur</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; background:#f4f6f9; margin:0; padding:0; }
h2 { background:#1976d2; color:#fff; padding:10px; text-align:center; }
form, .card {
  background:#fff; margin:20px auto; max-width:480px; padding:20px;
  border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1);
}
label { display:block; margin-top:10px; font-weight:bold; }
input, select, textarea {
  width:100%; padding:8px; border:1px solid #ccc; border-radius:6px;
}
button {
  width:100%; background:#1976d2; color:white; border:none;
  padding:10px; border-radius:6px; font-weight:bold; margin-top:10px; cursor:pointer;
}
button:hover { background:#0d47a1; }
#map, #mapData { height:320px; border-radius:6px; margin-top:10px; }
#msg { text-align:center; font-weight:bold; margin-top:10px; }
.preview { display:block; width:100%; max-height:200px; margin-top:5px; border-radius:8px; object-fit:cover; }
.hidden { display:none; }
#chartContainer { background:#fff; margin:20px auto; max-width:600px; padding:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
</style>
</head>

<body>
<h2>📋 Monitoring PJU (TINJU v4) – Kabupaten Barito Timur</h2>

<!-- 🔐 LOGIN -->
<div id="loginCard" class="card">
  <h3>🔐 Login Petugas</h3>
  <label>Username:</label><input type="text" id="username" required>
  <label>Password:</label><input type="password" id="password" required>
  <button id="loginBtn">Masuk</button>
  <div id="loginMsg"></div>
</div>

<!-- 📋 FORM -->
<form id="tinjuForm" class="hidden">
  <h3>Form Monitoring PJU</h3>
  <label>Tanggal:</label><input type="date" id="tanggal" required>
  <label>Petugas:</label><input type="text" id="petugas" readonly>
  <label>Nama Lokasi / Panel:</label><input type="text" id="lokasi" required>
  <label>Koordinat:</label><input type="text" id="koordinat" readonly required>
  <div id="map"></div>
  <button type="button" id="lokasiSaya">📍 Ambil Lokasi Saya</button>
  <label>Jenis Kerusakan:</label>
  <select id="jenis" required>
    <option value="">Pilih Jenis Kerusakan</option>
    <option>Lampu</option><option>Jaringan Kabel</option>
    <option>Kontroller/Proteksi</option><option>Short Circuit</option>
    <option>Hilang Tegangan</option><option>Tidak Diketahui</option>
  </select>
  <label>Keterangan:</label><textarea id="keterangan" rows="3"></textarea>
  <label>📸 Upload Foto:</label><input type="file" id="foto" accept="image/*">
  <img id="preview" class="preview hidden">
  <button type="submit">✅ Kirim Data</button>
  <button type="button" id="logoutBtn" style="background:#b71c1c;">🚪 Logout</button>
</form>

<h2>🗺️ Data PJU</h2>
<div id="mapData"></div>

<!-- 📊 Chart -->
<div id="chartContainer">
  <h3>📊 Rekap Jenis Kerusakan</h3>
  <canvas id="jenisChart"></canvas>
</div>

<div id="msg"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbwcMi_pBDlXeEzS5wxpIuiRmDjvkiwjgR53TmcfhGyi0DcKTSj3sgGXxfmPEpbVhUgg4g/exec";
const proxyURL = "https://corsproxy.io/?";  // 🔹 Universal proxy
const fullURL = proxyURL + encodeURIComponent(scriptURL);

const loginCard = document.getElementById("loginCard");
const form = document.getElementById("tinjuForm");
let jenisChart;

// === LOGIN ===
document.getElementById("loginBtn").addEventListener("click", async () => {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  const res = await fetch(fullURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, password })
  });
  const data = await res.json();
  if (data.status === "success") {
    localStorage.setItem("petugas", data.nama);
    document.getElementById("petugas").value = data.nama;
    loginCard.classList.add("hidden");
    form.classList.remove("hidden");
    loadData();
  } else {
    document.getElementById("loginMsg").innerHTML = "⚠️ " + data.message;
  }
});

// === LOGOUT ===
document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.removeItem("petugas");
  form.classList.add("hidden");
  loginCard.classList.remove("hidden");
});

// === MAP INPUT ===
const map = L.map('map').setView([-2.13, 115.10], 9);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
let marker;
map.on('click', e => {
  const lat = e.latlng.lat.toFixed(6), lng = e.latlng.lng.toFixed(6);
  document.getElementById('koordinat').value = `${lat}, ${lng}`;
  if (marker) map.removeLayer(marker);
  marker = L.marker(e.latlng).addTo(map).bindPopup(`📍 ${lat}, ${lng}`).openPopup();
});
document.getElementById('lokasiSaya').addEventListener('click', () => {
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude.toFixed(6), lng = pos.coords.longitude.toFixed(6);
    document.getElementById('koordinat').value = `${lat}, ${lng}`;
    map.setView([lat, lng], 17);
    if (marker) map.removeLayer(marker);
    marker = L.marker([lat, lng]).addTo(map)
      .bindPopup(`📍 Lokasi Anda<br>${lat}, ${lng}`).openPopup();
  });
});

// === PREVIEW FOTO ===
document.getElementById('foto').addEventListener('change', e => {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = ev => {
      const img = document.getElementById('preview');
      img.src = ev.target.result;
      img.classList.remove("hidden");
    };
    reader.readAsDataURL(file);
  }
});

// === SUBMIT FORM ===
document.getElementById("tinjuForm").addEventListener("submit", async e => {
  e.preventDefault();
  const fotoFile = document.getElementById('foto').files[0];
  let fotoBase64 = "";
  if (fotoFile) fotoBase64 = await new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = () => res(r.result);
    r.onerror = rej;
    r.readAsDataURL(fotoFile);
  });

  const data = {
    tanggal: document.getElementById("tanggal").value,
    petugas: document.getElementById("petugas").value,
    lokasi: document.getElementById("lokasi").value,
    koordinat: document.getElementById("koordinat").value,
    jenis: document.getElementById("jenis").value,
    keterangan: document.getElementById("keterangan").value,
    fotoBase64
  };
  const res = await fetch(fullURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
  const r = await res.json();
  document.getElementById("msg").innerHTML = 
    r.status === "success" ? "✅ Data & foto berhasil dikirim!" : "⚠️ " + r.message;
  loadData();
});

// === MAP DATA ===
const mapData = L.map('mapData').setView([-2.13, 115.10], 9);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(mapData);

// 🎨 Marker style per jenis
const iconMap = {
  "Lampu": "yellow",
  "Jaringan Kabel": "orange",
  "Kontroller/Proteksi": "blue",
  "Short Circuit": "red",
  "Hilang Tegangan": "black",
  "Tidak Diketahui": "green"
};

async function loadData() {
  const res = await fetch(fullURL);
  const data = await res.json();
  mapData.eachLayer(l => { if (l instanceof L.Marker) mapData.removeLayer(l); });

  const count = {};
  data.forEach(d => {
    if (!d.koordinat) return;
    const [lat, lng] = d.koordinat.split(",").map(Number);
    const jenis = d.jenis || "Tidak Diketahui";
    count[jenis] = (count[jenis] || 0) + 1;
    const color = iconMap[jenis] || "gray";

    const markerIcon = L.divIcon({
      className: "custom-icon",
      html: `<div style="background:${color};width:16px;height:16px;border-radius:50%;border:2px solid white;"></div>`
    });

    const popup = `
      <b>${d.lokasi}</b><br>
      🧍 ${d.petugas}<br>
      📅 ${d.tanggal}<br>
      ⚙️ ${d.jenis}<br>
      📝 ${d.keterangan}<br>
      ${d.foto ? `<a href="${d.foto}" target="_blank">📸 Lihat Foto</a>` : ""}
    `;
    L.marker([lat, lng], { icon: markerIcon }).addTo(mapData).bindPopup(popup);
  });

  updateChart(count);
}

// === CHART ===
function updateChart(data) {
  const labels = Object.keys(data);
  const values = Object.values(data);
  const colors = labels.map(l => iconMap[l] || "gray");
  if (jenisChart) jenisChart.destroy();
  jenisChart = new Chart(document.getElementById("jenisChart"), {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{ label: "Jumlah Laporan", data: values, backgroundColor: colors }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });
}

loadData();
</script>
</body>
</html>
