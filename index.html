<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚ö° Admin Panel ‚Äì TINJU Barito Timur</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  margin: 0;
  background: radial-gradient(circle at center, #01020a 0%, #000 100%);
  font-family: 'Poppins', sans-serif;
  color: #00eaff;
  overflow-x: hidden;
}

/* === Header === */
header {
  background: linear-gradient(90deg, #001122, #002244);
  padding: 12px;
  text-align: center;
  color: #00ffff;
  font-weight: 700;
  font-size: 20px;
  letter-spacing: 1px;
  box-shadow: 0 0 15px #00ffff88;
  border-bottom: 2px solid #00ffff55;
}

/* === Logout Neon === */
#logoutBtn {
  background: linear-gradient(90deg, #ff0066, #ff6600);
  box-shadow: 0 0 10px #ff3366;
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  cursor: pointer;
  color: #fff;
  font-weight: bold;
  transition: 0.3s;
}
#logoutBtn:hover {
  box-shadow: 0 0 20px #ff6600;
  transform: scale(1.05);
}

/* === Efek Arus Listrik === */
.electric-border {
  position: relative;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 0 25px #00ffff33, inset 0 0 20px #00ffff11;
}
.electric-border::before {
  content: '';
  position: absolute;
  top: -2px; left: -2px; right: -2px; bottom: -2px;
  background: linear-gradient(120deg, #00ffff, #00eaff, #007bff, #00ffff);
  background-size: 400% 400%;
  border-radius: 14px;
  filter: blur(1.2px);
  animation: electricFlow 5s linear infinite;
  z-index: -1;
}
@keyframes electricFlow {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* === Form Input === */
form {
  background: rgba(0, 15, 30, 0.8);
  padding: 20px;
  margin: 20px auto;
  max-width: 480px;
  border-radius: 12px;
  box-shadow: 0 0 25px #00ffff33;
}
label { display:block; margin-top:10px; font-weight:bold; color:#00ffff; }
input, select, textarea {
  width:100%;
  padding:8px;
  border-radius:6px;
  border:1px solid #00ffff55;
  background:rgba(0,0,0,0.6);
  color:#00eaff;
  font-size:14px;
  outline:none;
}
button {
  width:100%;
  margin-top:10px;
  background:linear-gradient(90deg,#00ffff,#007bff);
  color:#000;
  border:none;
  padding:10px;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
  transition:0.3s;
  box-shadow:0 0 20px #00ffff55;
}
button:hover { background:linear-gradient(90deg,#007bff,#00ffff); box-shadow:0 0 30px #00ffff; transform:scale(1.05); }

/* === Map & Stats === */
#mapData, #map { height:320px; border-radius:10px; margin-top:10px; }
#msg { text-align:center; margin:10px; color:#ffcc00; font-weight:bold; }
#stats { width:90%; max-width:600px; margin:20px auto; }
canvas { background:#000814; border-radius:12px; box-shadow:0 0 20px #00ffff33; }

</style>
</head>

<body>
<header>
  ‚ö° PANEL ADMIN ‚Äì MONITORING PJU BARITO TIMUR ‚ö°
  <div style="margin-top:5px;">
    <span id="userInfo"></span>
    <button id="logoutBtn">üö™ Logout</button>
  </div>
</header>

<!-- üîπ Form Input -->
<div class="electric-border">
<form id="tinjuForm">
  <label>Tanggal:</label>
  <input type="date" id="tanggal" required>

  <label>Petugas:</label>
  <input type="text" id="petugas" readonly>

  <label>Nama Lokasi / Panel:</label>
  <input type="text" id="lokasi" required>

  <label>Koordinat:</label>
  <input type="text" id="koordinat" readonly required>
  <div id="map"></div>
  <button type="button" id="lokasiSaya">üìç Ambil Lokasi Saya</button>

  <label>Jenis Kerusakan:</label>
  <select id="jenis" required>
    <option value="">Pilih Jenis Kerusakan</option>
    <option value="Lampu">Lampu</option>
    <option value="Jaringan Kabel">Jaringan Kabel</option>
    <option value="Kontroller/Proteksi">Kontroller/Proteksi</option>
    <option value="Short Circuit">Short Circuit</option>
    <option value="Hilang Tegangan">Hilang Tegangan</option>
    <option value="Tidak Diketahui">Tidak Diketahui</option>
  </select>

  <label>Keterangan:</label>
  <textarea id="keterangan" rows="3"></textarea>

  <label>üì∏ Upload Foto:</label>
  <input type="file" id="foto" accept="image/*">

  <button type="submit">‚úÖ Kirim Data</button>
</form>
</div>

<div id="msg"></div>

<!-- üîπ Statistik -->
<div class="electric-border" id="stats">
  <canvas id="chartJenis"></canvas>
</div>

<!-- üîπ Peta Output -->
<div class="electric-border">
  <div id="mapData"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const proxy = "https://broad-queen-be12.perluasanlistrik-bartim.workers.dev/?url=";
const scriptURL = "https://script.google.com/macros/s/AKfycbwcMi_pBDlXeEzS5wxpIuiRmDjvkiwjgR53TmcfhGyi0DcKTSj3sgGXxfmPEpbVhUgg4g/exec";

document.addEventListener("DOMContentLoaded", async () => {
  const user = localStorage.getItem("petugas");
  const role = localStorage.getItem("role");
  if (!user) {
    alert("‚ö†Ô∏è Anda harus login dahulu!");
    window.location.href = "login.html";
    return;
  }

  document.getElementById("userInfo").innerText = `üë§ ${user} (${role})`;
  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.clear();
    window.location.href = "login.html";
  });
  document.getElementById("petugas").value = user;
  document.getElementById("tanggal").valueAsDate = new Date();

  const map = L.map('map').setView([-2.13, 115.10], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
  let marker;

  document.getElementById('lokasiSaya').addEventListener('click', () => {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude.toFixed(6);
      const lng = pos.coords.longitude.toFixed(6);
      document.getElementById('koordinat').value = `${lat}, ${lng}`;
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map).bindPopup("üìç Lokasi Anda").openPopup();
      map.setView([lat, lng], 15);
    });
  });

  // === Kirim data ===
  document.getElementById("tinjuForm").addEventListener("submit", async e => {
    e.preventDefault();
    const fotoFile = document.getElementById("foto").files[0];
    let fotoBase64 = "";
    if (fotoFile) {
      fotoBase64 = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(fotoFile);
      });
    }
    const data = {
      action: "upload",
      tanggal: document.getElementById("tanggal").value,
      petugas: user,
      lokasi: document.getElementById("lokasi").value,
      koordinat: document.getElementById("koordinat").value,
      jenis: document.getElementById("jenis").value,
      keterangan: document.getElementById("keterangan").value,
      fotoBase64
    };
    document.getElementById("msg").innerText = "‚ö° Mengirim data...";
    const res = await fetch(proxy + scriptURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    const r = await res.json();
    document.getElementById("msg").innerText = r.status === "success" ? "‚úÖ Data berhasil dikirim!" : "‚ùå " + r.message;
    loadData();
  });

  // === Map Output + Statistik ===
  const mapData = L.map('mapData').setView([-2.13, 115.10], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(mapData);

  async function loadData() {
    const res = await fetch(proxy + scriptURL);
    const data = await res.json();
    mapData.eachLayer(l => { if (l instanceof L.Marker) mapData.removeLayer(l); });
    const counts = {};

    data.forEach(d => {
      if (!d.koordinat) return;
      const [lat, lng] = d.koordinat.split(",").map(Number);
      const jenis = d.jenis || "Lainnya";
      counts[jenis] = (counts[jenis] || 0) + 1;

      const iconColor = {
        "Lampu": "yellow",
        "Jaringan Kabel": "red",
        "Kontroller/Proteksi": "cyan",
        "Short Circuit": "orange",
        "Hilang Tegangan": "purple",
        "Tidak Diketahui": "gray"
      }[jenis] || "blue";

      const icon = L.divIcon({
        className: "custom-icon",
        html: `<div style="background:${iconColor};width:14px;height:14px;border-radius:50%;box-shadow:0 0 10px ${iconColor};"></div>`
      });

      L.marker([lat, lng], { icon }).addTo(mapData)
        .bindPopup(`<b>${d.lokasi}</b><br>üßç ${d.petugas}<br>üìÖ ${d.tanggal}<br>‚öôÔ∏è ${d.jenis}<br>üìù ${d.keterangan}`);
    });

    // Chart Statistik
    const ctx = document.getElementById("chartJenis").getContext("2d");
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(counts),
        datasets: [{
          label: "Jumlah Laporan",
          data: Object.values(counts),
          backgroundColor: ["#ff0","#f00","#0ff","#fa0","#a0f","#888"]
        }]
      },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });
  }

  loadData();
});
</script>
</body>
</html>
