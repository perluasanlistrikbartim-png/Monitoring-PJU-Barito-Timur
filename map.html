<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üó∫Ô∏è Monitoring PJU ‚Äì Barito Timur</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>
body {font-family:'Segoe UI',sans-serif;margin:0;background:#000;color:#0ff;}
header {text-align:center;background:#002;border-bottom:1px solid #0ff55;padding:12px 0;font-weight:bold;}
#mapData {height:60vh;width:100%;margin-top:10px;}
table {width:96%;margin:15px auto;border-collapse:collapse;background:#001c2c;color:#0ff;}
th,td {border:1px solid #00ffff33;padding:6px;text-align:left;font-size:13px;}
th {background:#003344;}
td a{color:#0ff;text-decoration:none;}
img.thumb{width:60px;height:60px;object-fit:cover;border-radius:8px;margin:2px;border:1px solid #00ffff55;box-shadow:0 0 6px #00ffff77;}
.gallery {position:relative;width:95%;max-width:800px;margin:15px auto;}
.gallery img{width:100%;height:400px;object-fit:cover;border-radius:10px;box-shadow:0 0 25px #00ffff33;}
.gallery button{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.5);border:none;color:#0ff;font-size:1.6rem;padding:8px 12px;cursor:pointer;border-radius:50%;}
.gallery .prev{left:10px;}
.gallery .next{right:10px;}
</style>
</head>
<body>
<header>üó∫Ô∏è Monitoring & Laporan PJU Barito Timur</header>

<div style="text-align:center;margin:10px;">
  Filter Petugas:
  <select id="filterPetugas">
    <option value="Semua">Semua Petugas</option>
  </select>
</div>

<div class="gallery" id="galleryBox" style="display:none;">
  <img id="galleryImage" src="" alt="Galeri Foto">
  <button class="prev" id="prevBtn">‚ùÆ</button>
  <button class="next" id="nextBtn">‚ùØ</button>
</div>

<div id="mapData"></div>

<h3 style="text-align:center;">üìã Tabel Rekap Laporan PJU</h3>
<table id="laporanTable">
  <thead>
    <tr>
      <th>No</th><th>Tanggal</th><th>Petugas</th><th>Lokasi</th>
      <th>Koordinat</th><th>Jenis</th><th>Keterangan</th><th>Foto</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const PROXY="https://broad-queen-be12.perluasanlistrik-bartim.workers.dev/?url=";
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbwcMi_pBDlXeEzS5wxpIuiRmDjvkiwjgR53TmcfhGyi0DcKTSj3sgGXxfmPEpbVhUgg4g/exec";
const PLACEHOLDER="https://upload.wikimedia.org/wikipedia/commons/3/3f/Placeholder_view_vector.svg";

const mapData=L.map("mapData").setView([-2.13,115.10],9);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(mapData);
let markerMap=[],galleryImages=[],currentIndex=0;

/* üîß FIX fungsi normalisasi gambar */
function fixFotoLink(f){
  if(!f)return PLACEHOLDER;

  // base64 langsung tampil
  if(f.startsWith("data:image")) return f;

  // link file/view
  if(f.includes("drive.google.com/file/d/")){
    const id=f.match(/\/d\/(.*?)\//);
    if(id&&id[1])return`https://drive.google.com/uc?export=view&id=${id[1]}`;
  }

  // link drive.usercontent.google.com/download?id=...
  if(f.includes("drive.usercontent.google.com")){
    const id=f.match(/[?&]id=([^&]+)/);
    if(id&&id[1])return`https://drive.google.com/uc?export=view&id=${id[1]}`;
  }

  // sudah uc?export=view
  if(f.includes("uc?export=view")) return f;

  return PLACEHOLDER;
}

/* üîπ Galeri */
function showGallery(imgs){
  galleryImages=imgs.length?imgs:[PLACEHOLDER];
  document.getElementById("galleryBox").style.display="block";
  currentIndex=0;
  document.getElementById("galleryImage").src=galleryImages[0];
}
document.getElementById("prevBtn").onclick=()=>{if(!galleryImages.length)return;currentIndex=(currentIndex-1+galleryImages.length)%galleryImages.length;document.getElementById("galleryImage").src=galleryImages[currentIndex];};
document.getElementById("nextBtn").onclick=()=>{if(!galleryImages.length)return;currentIndex=(currentIndex+1)%galleryImages.length;document.getElementById("galleryImage").src=galleryImages[currentIndex];};

/* üîπ Fokus Map */
function setViewAndOpen(lat,lng,zoom=18){
  let best=null,bestD=Infinity;
  for(const m of markerMap){
    const dx=m.lat-lat,dy=m.lng-lng;const d2=dx*dx+dy*dy;
    if(d2<bestD){bestD=d2;best=m;}
  }
  mapData.setView([lat,lng],zoom);
  if(best){best.marker.openPopup();}
}

/* üîπ Klik koordinat di tabel */
document.addEventListener("click",e=>{
  const a=e.target.closest("a.coord-link");
  if(!a)return;
  e.preventDefault();
  const lat=parseFloat(a.dataset.lat),lng=parseFloat(a.dataset.lng);
  setViewAndOpen(lat,lng,18);
});

/* üîπ Ambil data dari Apps Script */
async function loadData(){
  const res=await fetch(PROXY+SCRIPT_URL);
  const data=await res.json();
  renderData(data);
}

/* üîπ Render */
function renderData(data){
  const petugasSet=new Set(data.map(d=>d.petugas).filter(Boolean));
  const sel=document.getElementById("filterPetugas");
  petugasSet.forEach(p=>{const opt=document.createElement("option");opt.value=p;opt.textContent=p;sel.appendChild(opt);});
  sel.onchange=()=>filterData(data);
  filterData(data);
}

/* üîπ Filter */
function filterData(data){
  const f=document.getElementById("filterPetugas").value;
  const filtered=f==="Semua"?data:data.filter(d=>d.petugas===f);
  updateMap(filtered);
  updateTable(filtered);
}

/* üîπ Map update */
function updateMap(data){
  mapData.eachLayer(l=>{if(l instanceof L.Marker)mapData.removeLayer(l);});
  markerMap=[];let allImgs=[];
  data.forEach(d=>{
    if(!d.koordinat||!d.koordinat.includes(","))return;
    const [lat,lng]=d.koordinat.split(",").map(Number);
    let fotoList=[];
    if(Array.isArray(d.foto)) fotoList=d.foto;
    else if(typeof d.foto==="string"&&d.foto.trim()!=="") fotoList=d.foto.split(",");
    fotoList=fotoList.map(f=>fixFotoLink(f.trim()));
    if(fotoList.length===0)fotoList=[PLACEHOLDER];
    allImgs.push(...fotoList);
    const popup=`<b>${d.lokasi||"-"}</b><br>üßç ${d.petugas||"-"}<br>üìÖ ${d.tanggal||"-"}<br>‚öôÔ∏è ${d.jenis||"-"}<br>üìù ${d.keterangan||"-"}<br><a href="${fotoList[0]}" target="_blank">üì∏ Lihat Foto</a>`;
    const icon=L.divIcon({html:`<span style='color:#0ff;font-size:20px;text-shadow:0 0 10px #0ff;'>‚ö°</span>`,className:""});
    const marker=L.marker([lat,lng],{icon}).addTo(mapData).bindPopup(popup);
    markerMap.push({lat,lng,marker});
  });
  showGallery(allImgs);
}

/* üîπ Tabel update */
function updateTable(data){
  const tbody=document.querySelector("#laporanTable tbody");tbody.innerHTML="";
  data.forEach((d,i)=>{
    let koordinatCell="-";
    if(d.koordinat&&d.koordinat.includes(",")){
      const [lat,lng]=d.koordinat.split(",").map(s=>s.trim());
      koordinatCell=`<a href="?lat=${lat}&lng=${lng}&z=18" class="coord-link" data-lat="${lat}" data-lng="${lng}">${lat}, ${lng}</a>`;
    }
    let fotoList=[];
    if(Array.isArray(d.foto)) fotoList=d.foto;
    else if(typeof d.foto==="string"&&d.foto.trim()!=="") fotoList=d.foto.split(",");
    fotoList=fotoList.map(f=>fixFotoLink(f.trim()));
    if(fotoList.length===0)fotoList=[PLACEHOLDER];
    const fotoCell=fotoList.map(f=>`<a href="${f}" target="_blank"><img class="thumb" src="${f}"></a>`).join("");
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i+1}</td><td>${d.tanggal||"-"}</td><td>${d.petugas||"-"}</td><td>${d.lokasi||"-"}</td><td>${koordinatCell}</td><td>${d.jenis||"-"}</td><td>${d.keterangan||"-"}</td><td>${fotoCell}</td>`;
    tbody.appendChild(tr);
  });
}

loadData();
</script>
</body>
</html>
