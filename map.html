<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üó∫Ô∏è Monitoring PJU ‚Äì Barito Timur</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body {
  font-family: 'Segoe UI', sans-serif;
  margin: 0;
  background: radial-gradient(circle at center, #000020, #000);
  color: #0ff;
  overflow-x: hidden;
}

/* ===== HEADER ===== */
header {
  text-align: center;
  background: linear-gradient(90deg, #001122, #003344);
  padding: 16px 10px;
  color: #0ff;
  font-weight: bold;
  font-size: 1.2rem;
  text-shadow: 0 0 10px #00ffff;
  border-bottom: 1px solid #00ffff44;
  box-shadow: 0 0 25px #00ffff55 inset;
}

/* ===== FILTER ===== */
.filter-box {
  text-align: center;
  margin: 15px auto;
  color: #0ff;
}
select#filterPetugas {
  background: #001122;
  color: #0ff;
  border: 1px solid #00ffff66;
  border-radius: 8px;
  padding: 6px 10px;
  font-size: 14px;
  box-shadow: 0 0 10px #00ffff33 inset;
}

/* ===== MAP ===== */
#mapData {
  height: 60vh;
  width: 100%;
  border-top: 1px solid #00ffff55;
  box-shadow: 0 0 20px #00ffff44 inset;
  z-index: 2;
}

/* ===== TABLE ===== */
table {
  width: 95%;
  margin: 20px auto 30px;
  border-collapse: collapse;
  background: rgba(0, 20, 40, 0.85);
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 0 25px #00ffff33;
}
th, td {
  border: 1px solid #00ffff33;
  padding: 8px;
  font-size: 13px;
  text-align: left;
}
th {
  background: linear-gradient(90deg,#003355,#001122);
  color: #0ff;
  text-shadow: 0 0 6px #00ffff;
}
td a {
  color: #0ff;
  text-decoration: none;
}
tr:nth-child(even) {
  background: rgba(0,255,255,0.05);
}
tr:hover {
  background: rgba(0,255,255,0.1);
}

/* ===== FOOTER ===== */
footer {
  text-align:center;
  padding:12px;
  background:linear-gradient(90deg,#001122,#003344);
  color:#0ff;
  font-weight:bold;
  text-shadow:0 0 10px #00ffffaa;
  border-top:1px solid #00ffff44;
  box-shadow:inset 0 0 25px #00ffff33;
  font-size:0.9rem;
}

/* ===== LIGHTNING ===== */
canvas#electricFX {
  position: fixed; top: 0; left: 0;
  width: 100vw; height: 100vh;
  pointer-events: none;
  z-index: 1;
  opacity: .5;
}
</style>
</head>

<body>
<canvas id="electricFX"></canvas>

<header>üó∫Ô∏è Monitoring & Laporan PJU Barito Timur</header>

<div class="filter-box">
  <label>Filter Petugas:</label>
  <select id="filterPetugas">
    <option value="Semua">Semua Petugas</option>
  </select>
</div>

<div id="mapData"></div>

<h3 style="text-align:center;margin-top:25px;text-shadow:0 0 10px #00ffff;">üìã Tabel Rekap Laporan PJU</h3>

<table id="laporanTable">
  <thead>
    <tr>
      <th>No</th>
      <th>Tanggal</th>
      <th>Petugas</th>
      <th>Lokasi</th>
      <th>Koordinat</th>
      <th>Jenis</th>
      <th>Keterangan</th>
      <th>Foto</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<footer>‚öôÔ∏è Tim Swakelola PJU Barito Timur ‚ö°</footer>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const PROXY="https://broad-queen-be12.perluasanlistrik-bartim.workers.dev/?url=";
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbwcMi_pBDlXeEzS5wxpIuiRmDjvkiwjgR53TmcfhGyi0DcKTSj3sgGXxfmPEpbVhUgg4g/exec";

const mapData=L.map("mapData").setView([-2.13,115.10],9);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(mapData);
let markerMap=[];

// ======== FUNGSI ========

function setViewAndOpen(lat,lng,zoom=18){
  let best=null,bestD=Infinity;
  for(const m of markerMap){
    const dx=m.lat-lat,dy=m.lng-lng;
    const d2=dx*dx+dy*dy;
    if(d2<bestD){bestD=d2;best=m;}
  }
  mapData.setView([lat,lng],zoom);
  if(best && Math.sqrt(bestD)<0.002) best.marker.openPopup();
}

function focusFromURL(){
  const q=new URLSearchParams(location.search);
  const lat=parseFloat(q.get("lat"));
  const lng=parseFloat(q.get("lng"));
  const z=parseInt(q.get("z")||"18",10);
  if(!isNaN(lat)&&!isNaN(lng)) setViewAndOpen(lat,lng,z);
}

document.addEventListener("click",e=>{
  const a=e.target.closest("a.coord-link");
  if(!a)return;
  e.preventDefault();
  const lat=parseFloat(a.dataset.lat);
  const lng=parseFloat(a.dataset.lng);
  const z=parseInt(a.dataset.zoom||"18",10);
  setViewAndOpen(lat,lng,z);
  history.replaceState(null,"",`?lat=${lat}&lng=${lng}&z=${z}`);
});

async function loadData(){
  const res=await fetch(PROXY+SCRIPT_URL);
  const data=await res.json();
  renderData(data);
}

function renderData(data){
  const petugasSet=new Set(data.map(d=>d.petugas).filter(Boolean));
  const sel=document.getElementById("filterPetugas");
  petugasSet.forEach(p=>{
    const opt=document.createElement("option");
    opt.value=p;opt.textContent=p;
    sel.appendChild(opt);
  });
  sel.onchange=()=>filterData(data);
  filterData(data);
}

function filterData(data){
  const f=document.getElementById("filterPetugas").value;
  const filtered=f==="Semua"?data:data.filter(d=>d.petugas===f);
  updateMap(filtered);
  updateTable(filtered);
  focusFromURL();
}

function updateMap(data){
  mapData.eachLayer(l=>{if(l instanceof L.Marker)mapData.removeLayer(l);});
  markerMap=[];

  data.forEach((d,i)=>{
    if(!d.koordinat||!d.koordinat.includes(","))return;
    const [lat,lng]=d.koordinat.split(",").map(Number);

    let fotoList=[];
    if(Array.isArray(d.foto))fotoList=d.foto.filter(Boolean);
    else if(typeof d.foto==="string"&&d.foto.trim()!=="")fotoList=[d.foto.trim()];

    const fotoLinks=fotoList.map((f,idx)=>{
      let link=f;
      if(f.includes("/view")){
        const id=f.match(/\/d\/(.*?)\//);
        if(id&&id[1])link=`https://drive.google.com/uc?export=view&id=${id[1]}`;
      }
      return `<a href="${link}" target="_blank">üì∏ Foto ${idx+1}</a>`;
    }).join("<br>");

    const popup=`
      <b>${d.lokasi||"-"}</b><br>
      üßç ${d.petugas||"-"}<br>
      üìÖ ${d.tanggal||"-"}<br>
      ‚öôÔ∏è ${d.jenis||"-"}<br>
      üìù ${d.keterangan||"-"}<br>
      ${fotoLinks}
    `;

    const icon=L.divIcon({html:`<span style='color:#0ff;font-size:20px;text-shadow:0 0 10px #00ffff;'>‚ö°</span>`,className:""});
    const marker=L.marker([lat,lng],{icon}).addTo(mapData).bindPopup(popup);
    markerMap.push({lat,lng,marker});
  });
}

function updateTable(data){
  const tbody=document.querySelector("#laporanTable tbody");
  tbody.innerHTML="";

  data.forEach((d,i)=>{
    let koordinatCell="-";
    if(d.koordinat&&d.koordinat.includes(",")){
      const [lat,lng]=d.koordinat.split(",").map(s=>s.trim());
      koordinatCell=`
        <a href="?lat=${lat}&lng=${lng}&z=18"
           class="coord-link"
           data-lat="${lat}" data-lng="${lng}" data-zoom="18"
           style="color:#0ff;text-decoration:none;">
           ${lat}, ${lng}
        </a>`;
    }

    let fotoList=[];
    if(Array.isArray(d.foto))fotoList=d.foto.filter(Boolean);
    else if(typeof d.foto==="string"&&d.foto.trim()!=="")fotoList=[d.foto.trim()];
    let fotoCell="-";
    if(fotoList.length>0){
      fotoCell=fotoList.map((f,idx)=>{
        let link=f;
        if(f.includes("/view")){
          const id=f.match(/\/d\/(.*?)\//);
          if(id&&id[1])link=`https://drive.google.com/uc?export=view&id=${id[1]}`;
        }
        return `<a href="${link}" target="_blank" title="Foto ${idx+1}">
                  <img src="${link}" style="width:60px;height:60px;object-fit:cover;
                    border-radius:6px;margin:2px;border:1px solid #00ffff55;
                    box-shadow:0 0 6px #00ffff66;">
                </a>`;
      }).join("");
    }

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${d.tanggal||"-"}</td>
      <td>${d.petugas||"-"}</td>
      <td>${d.lokasi||"-"}</td>
      <td>${koordinatCell}</td>
      <td>${d.jenis||"-"}</td>
      <td>${d.keterangan||"-"}</td>
      <td>${fotoCell}</td>
    `;
    tr.addEventListener("click",()=>{
      if(d.koordinat&&d.koordinat.includes(",")){
        const [lat,lng]=d.koordinat.split(",").map(Number);
        setViewAndOpen(lat,lng,18);
      }
    });
    tbody.appendChild(tr);
  });
}

loadData();

// ‚ö° Efek kilat
const c=document.getElementById("electricFX"),ctx=c.getContext("2d");
function resize(){c.width=innerWidth;c.height=innerHeight;}
resize();addEventListener("resize",resize);
function lightning(){
  ctx.clearRect(0,0,c.width,c.height);
  for(let i=0;i<3;i++){
    const sx=Math.random()*c.width;
    ctx.beginPath();ctx.moveTo(sx,0);
    for(let y=0;y<c.height;y+=40){
      ctx.lineTo(sx+Math.random()*40-20,y+40);
    }
    ctx.strokeStyle=`rgba(0,255,255,${Math.random()*0.3+0.1})`;
    ctx.lineWidth=1.2;ctx.shadowBlur=12;ctx.shadowColor="#0ff";ctx.stroke();
  }
}
setInterval(lightning,300);
</script>
</body>
</html>
